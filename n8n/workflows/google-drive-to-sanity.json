{
  "name": "Google Drive Manual Blog Post (MVP)",
  "nodes": [
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "position": [180, 300],
      "typeVersion": 1
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "resource": "folder",
        "operation": "search",
        "folderId": "1Z6qZ28zbGX2jDxqoqE4MKBmyb3Fi-p0F",
        "options": {
          "filter": "*.md"
        }
      },
      "id": "get-unpublished-files",
      "name": "Get Unpublished Files (日本語)",
      "type": "n8n-nodes-base.googleDrive",
      "position": [380, 300],
      "typeVersion": 3,
      "credentials": {
        "googleApi": {
          "id": "google-drive-credential",
          "name": "Google Drive Service Account"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "resource": "file",
        "operation": "download",
        "fileId": "={{ $json.id }}"
      },
      "id": "download-file",
      "name": "Download File Content",
      "type": "n8n-nodes-base.googleDrive",
      "position": [600, 300],
      "typeVersion": 3,
      "credentials": {
        "googleApi": {
          "id": "google-drive-credential",
          "name": "Google Drive Service Account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Google Driveからのファイルデータを解析してSanity記事形式に変換\nconst fileName = $input.first().json.name;\nconst fileContent = $input.first().binary.data.toString();\n\n// YAMLフロントマターを解析（テンプレート形式前提）\nfunction parseFrontMatter(content) {\n  const frontMatterRegex = /^---\\n([\\s\\S]*?)\\n---\\n([\\s\\S]*)$/;\n  const match = content.match(frontMatterRegex);\n  \n  const frontMatter = match[1];\n  const bodyContent = match[2];\n  \n  // YAML形式を簡易パース\n  const metadata = {};\n  frontMatter.split('\\n').forEach(line => {\n    const colonIndex = line.indexOf(':');\n    if (colonIndex > 0) {\n      const key = line.substring(0, colonIndex).trim();\n      const value = line.substring(colonIndex + 1).trim();\n      \n      // gallery配列の処理\n      if (key === 'gallery') {\n        metadata[key] = [];\n      } else if (line.startsWith('  - ')) {\n        const item = line.replace('  - ', '').trim();\n        if (metadata.gallery) {\n          metadata.gallery.push(item);\n        }\n      } else {\n        metadata[key] = value;\n      }\n    }\n  });\n  \n  return {\n    metadata: metadata,\n    content: bodyContent\n  };\n}\n\n// Markdownコンテンツを Portable Text に変換\nfunction convertToPortableText(markdownContent) {\n  const blocks = [];\n  const lines = markdownContent.trim().split('\\n');\n  let currentBlock = null;\n  \n  lines.forEach(line => {\n    if (line.trim() === '') {\n      if (currentBlock && currentBlock.children.length > 0) {\n        blocks.push(currentBlock);\n        currentBlock = null;\n      }\n      return;\n    }\n    \n    // 画像記法の処理 ![alt](image.jpg)\n    const imageMatch = line.match(/^!\\[([^\\]]*)\\]\\(([^\\)]+)\\)$/);\n    if (imageMatch) {\n      if (currentBlock) {\n        blocks.push(currentBlock);\n        currentBlock = null;\n      }\n      \n      const altText = imageMatch[1];\n      const imageFileName = imageMatch[2];\n      \n      // 画像ブロック（将来的にSanity Asset参照に置換予定）\n      blocks.push({\n        _type: 'image',\n        _key: `image-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n        alt: altText,\n        // TODO: 実際の画像アップロード後にasset参照を設定\n        asset: {\n          _type: 'reference',\n          _ref: `placeholder-${imageFileName}`\n        },\n        hotspot: {\n          x: 0.5,\n          y: 0.5,\n          height: 1,\n          width: 1\n        },\n        crop: {\n          top: 0,\n          bottom: 0,\n          left: 0,\n          right: 0\n        }\n      });\n      return;\n    }\n    \n    // 見出しの処理\n    if (line.startsWith('#')) {\n      if (currentBlock) blocks.push(currentBlock);\n      const level = line.match(/^#+/)[0].length;\n      const style = level === 1 ? 'h1' : level === 2 ? 'h2' : 'h3';\n      currentBlock = {\n        _type: 'block',\n        _key: `block-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n        style: style,\n        markDefs: [],\n        children: [{\n          _type: 'span',\n          _key: `span-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n          text: line.replace(/^#+\\s*/, ''),\n          marks: []\n        }]\n      };\n      blocks.push(currentBlock);\n      currentBlock = null;\n      return;\n    }\n    \n    // 通常のテキストブロック\n    if (!currentBlock) {\n      currentBlock = {\n        _type: 'block',\n        _key: `block-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n        style: 'normal',\n        markDefs: [],\n        children: []\n      };\n    }\n    \n    if (currentBlock.children.length > 0) {\n      currentBlock.children.push({\n        _type: 'span',\n        _key: `span-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n        text: '\\n' + line,\n        marks: []\n      });\n    } else {\n      currentBlock.children.push({\n        _type: 'span',\n        _key: `span-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n        text: line,\n        marks: []\n      });\n    }\n  });\n  \n  if (currentBlock && currentBlock.children.length > 0) {\n    blocks.push(currentBlock);\n  }\n  \n  return blocks;\n}\n\n// Sanity用のスラッグ生成\nfunction generateSlug(title) {\n  return title\n    .toLowerCase()\n    .replace(/[\\s\\u3040-\\u309F\\u30A0-\\u30FF\\u4E00-\\u9FAF]/g, '-')\n    .replace(/-+/g, '-')\n    .replace(/^-|-$/g, '')\n    .slice(0, 96);\n}\n\n// メイン処理\nconst parsed = parseFrontMatter(fileContent);\nconst metadata = parsed.metadata;\nconst bodyContent = parsed.content;\n\n// Sanity記事オブジェクトを構築（テンプレート前提）\nconst sanityArticle = {\n  _type: 'article',\n  title: metadata.title,\n  slug: {\n    _type: 'slug',\n    current: generateSlug(metadata.title)\n  },\n  lang: 'ja',\n  type: metadata.type,\n  placeName: metadata.placeName || '',\n  prefecture: metadata.prefecture,\n  publishedAt: metadata.publishedAt,\n  body: convertToPortableText(bodyContent)\n};\n\n// カバー画像とギャラリー画像の設定（将来的にSanity Asset参照）\nif (metadata.coverImage) {\n  sanityArticle.coverImage = {\n    _type: 'image',\n    asset: {\n      _type: 'reference',\n      _ref: `placeholder-${metadata.coverImage}`\n    }\n  };\n}\n\nif (metadata.gallery && metadata.gallery.length > 0) {\n  sanityArticle.gallery = metadata.gallery.map(img => ({\n    _type: 'image',\n    _key: `gallery-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n    asset: {\n      _type: 'reference',\n      _ref: `placeholder-${img}`\n    }\n  }));\n}\n\nreturn [{\n  json: {\n    sanityArticle: sanityArticle,\n    originalFileName: fileName,\n    processedAt: new Date().toISOString()\n  }\n}];"
      },
      "id": "parse-content",
      "name": "Parse File Content",
      "type": "n8n-nodes-base.code",
      "position": [620, 300],
      "typeVersion": 2
    },
    {
      "parameters": {
        "url": "https://fcz6on8p.api.sanity.io/v2024-01-01/data/mutate/production",
        "method": "POST",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer YOUR_SANITY_API_TOKEN"
            }
          ]
        },
        "sendBody": true,
        "contentType": "json",
        "jsonBody": "={{ JSON.stringify({\n  mutations: [\n    {\n      create: $json.sanityArticle\n    }\n  ]\n}) }}",
        "options": {}
      },
      "id": "create-sanity-article",
      "name": "Create Sanity Article (HTTP)",
      "type": "n8n-nodes-base.httpRequest",
      "position": [840, 300],
      "typeVersion": 4.1
    },
    {
      "parameters": {
        "url": "https://my-sanity-site.vercel.app/api/revalidate",
        "method": "POST",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "secret",
              "value": "YOUR_REVALIDATE_SECRET"
            },
            {
              "name": "path",
              "value": "={{ '/article/' + $json.sanityArticle.slug.current }}"
            }
          ]
        },
        "options": {}
      },
      "id": "trigger-revalidation",
      "name": "Trigger ISR Revalidation",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1060, 300],
      "typeVersion": 4.1
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "resource": "file",
        "operation": "move",
        "fileId": "={{ $('Get Unpublished Files (日本語)').item.json.id }}",
        "folderId": "1Mmmz0BP5EBkRkZJ52wqLn5airSpahaaU"
      },
      "id": "move-to-published",
      "name": "Move to Published Folder (日本語)",
      "type": "n8n-nodes-base.googleDrive",
      "position": [1280, 300],
      "typeVersion": 3,
      "credentials": {
        "googleApi": {
          "id": "google-drive-credential",
          "name": "Google Drive Service Account"
        }
      }
    }
  ],
  "connections": {
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Get Unpublished Files (日本語)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Unpublished Files (日本語)": {
      "main": [
        [
          {
            "node": "Download File Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download File Content": {
      "main": [
        [
          {
            "node": "Parse File Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse File Content": {
      "main": [
        [
          {
            "node": "Create Sanity Article",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Sanity Article": {
      "main": [
        [
          {
            "node": "Trigger ISR Revalidation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger ISR Revalidation": {
      "main": [
        [
          {
            "node": "Move to Published Folder (日本語)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": ["blog", "automation", "sanity"],
  "triggerCount": 1,
  "updatedAt": "2025-01-27T00:00:00.000Z",
  "versionId": "1.0.0"
}