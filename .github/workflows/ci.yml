name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run TypeScript type check
      run: npm run typecheck

    - name: Run ESLint
      run: npm run lint

    - name: Run tests
      run: npm test

    - name: Build Sanity Studio (if applicable)
      run: npm run build --if-present
      continue-on-error: true

  post-cli-integration:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Test CLI help command
      run: npm run post -- --help

    - name: Create sample markdown file
      run: |
        mkdir -p test-content
        cat > test-content/sample.md << 'EOF'
        ---
        title: "CI Test Post"
        slug: "ci-test-post"
        publishedAt: "2024-01-15T10:00:00.000Z"
        excerpt: "Test post created during CI"
        tags: ["ci", "test"]
        author: "GitHub Actions"
        ---

        # CI Test

        This is a test post created during CI.

        ## Features Tested

        - Markdown parsing
        - Front matter validation
        - Portable Text conversion

        **Bold text** and *italic text* should work.

        ```javascript
        console.log('Code blocks too!');
        ```
        EOF

    - name: Test CLI without API token (should fail gracefully)
      run: |
        # This should fail with proper error message
        if npm run post test-content/sample.md 2>&1 | grep -q "Missing required environment variables"; then
          echo "✅ CLI properly handles missing environment variables"
        else
          echo "❌ CLI did not handle missing environment variables correctly"
          exit 1
        fi
      continue-on-error: false