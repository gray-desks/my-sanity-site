name: ğŸ§ª CI/CD Pipeline

on:
  push:
    branches: [ main, development ]
  pull_request:
    branches: [ main ]

jobs:
  test-build:
    name: ğŸ—ï¸ Test & Build
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'site/package-lock.json'
          
      - name: ğŸ”§ Install dependencies
        working-directory: ./site
        run: npm ci
        
      - name: ğŸ¯ Type check
        working-directory: ./site
        run: npx tsc --noEmit
        
      - name: ğŸ—ï¸ Build Astro site
        working-directory: ./site
        run: npm run build
        env:
          PUBLIC_SANITY_PROJECT_ID: ${{ secrets.PUBLIC_SANITY_PROJECT_ID }}
          PUBLIC_SANITY_DATASET: production
          
      - name: ğŸ“Š Build summary
        run: |
          echo "âœ… Build completed successfully!"
          echo "ğŸ“ Site output: site/dist"
          ls -la site/dist/ || echo "No dist directory found"

  lighthouse-audit:
    name: ğŸ” Performance Audit
    needs: test-build
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'site/package-lock.json'
          
      - name: ğŸ”§ Install dependencies
        working-directory: ./site
        run: npm ci
        
      - name: ğŸ—ï¸ Build for audit
        working-directory: ./site
        run: npm run build
        env:
          PUBLIC_SANITY_PROJECT_ID: ${{ secrets.PUBLIC_SANITY_PROJECT_ID }}
          PUBLIC_SANITY_DATASET: production
          
      - name: ğŸš€ Start preview server
        working-directory: ./site
        run: |
          npm run preview &
          sleep 5
          
      - name: ğŸ” Run Lighthouse audit
        uses: treosh/lighthouse-ci-action@v10
        with:
          configPath: './.github/lighthouse/config.json'
          uploadArtifacts: true
          temporaryPublicStorage: true