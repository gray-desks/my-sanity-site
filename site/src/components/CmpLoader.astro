---
// CMP (Consent Management Platform) + Google Consent Mode v2
// EU/UK/CHåœ°åŸŸã§ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼åŒæ„ã‚’ç®¡ç†ã—ã€gtag consentã‚’åˆ¶å¾¡

const { CMP_VENDOR, CMP_ID, AD_ENABLED } = import.meta.env;
---

<!-- CMPå®Ÿè£…ï¼ˆç’°å¢ƒå¤‰æ•°ã§åˆ¶å¾¡ï¼‰ -->
{CMP_VENDOR === 'cookieyes' && CMP_ID && CMP_ID !== 'REPLACE_ME' && (
  <>
    <!-- Google Consent Mode v2: åˆæœŸè¨­å®šï¼ˆdeniedï¼‰ -->
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      
      // åŒæ„å‰: å…¨ã¦deniedçŠ¶æ…‹
      gtag('consent', 'default', {
        ad_storage: 'denied',
        ad_user_data: 'denied',
        ad_personalization: 'denied',
        analytics_storage: 'denied'
      });
      
      // Debug log for AdSense review
      console.log('ğŸ”’ Consent Mode v2: Initial state set to denied');
    </script>

    <!-- CookieYes CMP Script -->
    <script 
      id="cookieyes" 
      type="text/javascript" 
      src={`https://cdn-cookieyes.com/client_data/${CMP_ID}/script.js`}
      is:inline
    ></script>

    <!-- CMPåŒæ„æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ -->
    <script is:inline>
      window.addEventListener('load', function() {
        // CookieYesåŒæ„æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
        window.addEventListener('cookieyes_consent_update', function(e) {
          const consentData = e.detail || {};
          const accepted = consentData.accepted || [];
          
          // åŒæ„çŠ¶æ…‹åˆ¤å®š
          const granted = (category) => accepted.includes(category) ? 'granted' : 'denied';
          
          // Google Consent Mode v2 æ›´æ–°
          gtag('consent', 'update', {
            ad_storage: granted('advertisement'),
            ad_user_data: granted('advertisement'),
            ad_personalization: granted('advertisement'),
            analytics_storage: granted('analytics')
          });
          
          // Debug log
          console.log('ğŸ”“ Consent Mode v2: Updated based on user choice', {
            ad_storage: granted('advertisement'),
            analytics_storage: granted('analytics')
          });
        });
        
        // åˆå›èª­ã¿è¾¼ã¿æ™‚ã®åŒæ„çŠ¶æ…‹ç¢ºèª
        if (window.cookieyes && window.cookieyes.getConsentData) {
          const currentConsent = window.cookieyes.getConsentData();
          if (currentConsent && currentConsent.accepted) {
            const accepted = currentConsent.accepted;
            const granted = (category) => accepted.includes(category) ? 'granted' : 'denied';
            
            gtag('consent', 'update', {
              ad_storage: granted('advertisement'),
              ad_user_data: granted('advertisement'),
              ad_personalization: granted('advertisement'),
              analytics_storage: granted('analytics')
            });
            
            console.log('ğŸ”„ Consent Mode v2: Restored from existing consent');
          }
        }
      });
    </script>
  </>
)}

<!-- CMPæœªè¨­å®šã®å ´åˆã®è­¦å‘Šï¼ˆé–‹ç™ºç’°å¢ƒã®ã¿ï¼‰ -->
{(import.meta.env.DEV && (!CMP_ID || CMP_ID === 'REPLACE_ME')) && (
  <script is:inline>
    console.warn('âš ï¸ CMP not configured. Set CMP_ID in .env for GDPR compliance');
  </script>
)}

<!-- AdSenseç„¡åŠ¹æ™‚ã®ç¢ºèªãƒ­ã‚° -->
{AD_ENABLED === 'false' && (
  <script is:inline>
    console.log('ğŸ“µ AdSense DISABLED for review period');
  </script>
)}