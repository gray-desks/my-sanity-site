---
import { getUILabel, DEFAULT_LANGUAGE } from '../lib/i18n'
import { getPrefecturesForLanguage } from '../lib/prefectures'
import { getAvailablePrefectures } from '../lib/sanity'

export interface Props {
  lang?: string
}

const { lang = DEFAULT_LANGUAGE } = Astro.props

// „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„ÉÜ„Ç≠„Çπ„Éà„ÅÆÂÆöÁæ© (i18nÂØæÂøú)
const searchPlaceholder = getUILabel(lang, 'searchPlaceholder')
// „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Åß‰ΩøÁî®„Åô„ÇãÊñáË®Ä„Çí„Çµ„Éº„ÉêÂÅ¥„ÅßÂÖà„Å´Á¢∫ÂÆöÔºà„Éñ„É©„Ç¶„Ç∂„Åß getUILabel „ÇíÂëº„Å∞„Å™„ÅÑÔºâ
const noResultsTitle = getUILabel(lang, 'noArticlesTitle')
const noResultsSubtitle = getUILabel(lang, 'noArticlesSubtitle')

// Ë®ò‰∫ã„Çø„Ç§„Éó„ÅÆÂÆöÁæ©
const articleTypes = [
  { value: '', label: getUILabel(lang, 'allTypes') },
  { value: 'spot', label: getUILabel(lang, 'spot') },
  { value: 'food', label: getUILabel(lang, 'food') },
  { value: 'transport', label: getUILabel(lang, 'transport') },
  { value: 'hotel', label: getUILabel(lang, 'hotel') },
  { value: 'note', label: getUILabel(lang, 'note') }
]

// Ë®ò‰∫ã„ÅåÂ≠òÂú®„Åô„ÇãÈÉΩÈÅìÂ∫úÁúå„ÅÆ„ÅøÂèñÂæóÔºàÂ§öË®ÄË™ûÂØæÂøúÔºâ
// Â§±ÊïóÊôÇ„ÅØÂÖ®ÈÉΩÈÅìÂ∫úÁúå„ÇíË°®Á§∫„Åó„Å¶SSR„Ç®„É©„Éº„ÇíÂõûÈÅø
let availablePrefectureCodes: string[] = []
try {
  availablePrefectureCodes = await getAvailablePrefectures(lang)
} catch (e) {
  console.error('Failed to fetch available prefectures:', e)
}
const allPrefectures = getPrefecturesForLanguage(lang)

// Ë®ò‰∫ã„ÅåÂ≠òÂú®„Åô„ÇãÈÉΩÈÅìÂ∫úÁúå„ÅÆ„Åø„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÔºàÂèñÂæóÂ§±ÊïóÊôÇ„ÅØÂÖ®‰ª∂Ôºâ
const availablePrefectures = (availablePrefectureCodes && availablePrefectureCodes.length > 0)
  ? allPrefectures.filter(p => availablePrefectureCodes.includes(p.code))
  : allPrefectures

const prefectures = [
  { code: '', name: getUILabel(lang, 'allPrefectures') },
  ...availablePrefectures.map(p => ({ code: p.code, name: p.name }))
]
---

<div
  id="search-filter"
  class="search-card rounded-2xl border border-[var(--theme-accent)]/15 bg-white/95 backdrop-blur-sm shadow-lg ring-1 ring-[var(--theme-accent)]/5 px-3 py-3 md:px-4 md:py-4 mb-8"
  data-lang={lang}
  data-no-results-title={noResultsTitle}
  data-no-results-subtitle={noResultsSubtitle}
>
  <!-- Mobile: 2-tier layout -->
  <div class="block md:hidden space-y-3">
    <!-- Tier 1: Search + Button -->
    <div class="grid grid-cols-[1fr,auto] gap-2 items-center">
      <!-- Search Input -->
      <div class="relative">
        <input
          type="text"
          id="search-input"
          placeholder={searchPlaceholder}
          class="search-field w-full h-12 pl-10 pr-4 text-sm placeholder:text-neutral-400 text-ink bg-white/95 border border-neutral-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--theme-accent)] focus:border-transparent transition-all duration-200"
          aria-label={getUILabel(lang, 'searchKeyword')}
        />
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>
      </div>
      
      <!-- Search Button -->
      <button
        id="search-button"
        class="cta-search h-12 px-5 bg-[var(--theme-accent)] text-white font-semibold rounded-xl shadow-md hover:bg-[var(--theme-accent)]/90 focus:outline-none focus:ring-2 focus:ring-[var(--theme-accent)] transition-all duration-200 hover:-translate-y-0.5"
        aria-label={getUILabel(lang, 'search')}
      >
        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </button>
    </div>

    <!-- Tier 2: Collapsible Filters -->
    <div class="relative">
      <!-- Filter Toggle Chip -->
      <div class="flex items-center justify-between mb-2">
        <span class="text-xs text-neutral-500">{getUILabel(lang, 'filters')}</span>
        <button
          id="filter-toggle"
          class="inline-flex items-center gap-1 px-3 py-1 text-xs font-medium bg-[var(--theme-accent-weak)] text-[var(--theme-ink-strong)] rounded-full hover:brightness-95 transition-all"
          aria-label={getUILabel(lang, 'toggleFilters')}
        >
          <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
          </svg>
          <svg id="filter-icon" class="h-3 w-3 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
      </div>
      
      <!-- Collapsible Filter Panel -->
      <div id="filter-panel" class="max-h-0 overflow-hidden transition-all duration-300 ease-in-out">
        <div class="space-y-3 pt-1">

          <!-- Type Filter -->
          <select
            id="type-filter"
            class="select-field w-full pl-4 pr-10 py-2.5 text-sm text-ink bg-white/95 border border-neutral-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--theme-accent)] focus:border-transparent transition-all duration-200 appearance-none cursor-pointer"
          >
            {articleTypes.map(type => (
              <option value={type.value}>{type.label}</option>
            ))}
          </select>
          
          <!-- Prefecture Filter -->
          <select
            id="prefecture-filter"
            class="select-field w-full pl-4 pr-10 py-2.5 text-sm text-ink bg-white/95 border border-neutral-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--theme-accent)] focus:border-transparent transition-all duration-200 appearance-none cursor-pointer"
          >
            {prefectures.map(prefecture => (
              <option value={prefecture.code}>{prefecture.name}</option>
            ))}
          </select>
          
          <!-- Reset Button -->
          <button
            id="reset-button"
            class="cta-reset w-full py-2.5 bg-neutral-100/90 text-neutral-700 font-medium rounded-xl shadow-sm hover:bg-neutral-200 focus:outline-none focus:ring-2 focus:ring-neutral-400 transition-all duration-200"
          >
            {getUILabel(lang, 'reset')}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Desktop: Original 3-column layout -->
  <div class="hidden md:flex flex-col lg:flex-row gap-4">

    <!-- Desktop Search Field -->
    <div class="flex-1">
      <div class="relative">
        <input
          type="text"
          id="search-input-desktop"
          placeholder={searchPlaceholder}
          class="search-field w-full pl-12 pr-4 py-3 text-ink bg-white/95 border border-neutral-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--theme-accent)] focus:border-transparent transition-all duration-200"
          aria-label={getUILabel(lang, 'searchKeyword')}
        />
        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
          <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>
      </div>
    </div>

    <!-- Desktop Filter Selects -->
    <div class="flex flex-col sm:flex-row gap-4 flex-shrink-0">
      <!-- Type Filter -->
      <select
        id="type-filter-desktop"
        class="select-field w-full sm:w-auto pl-4 pr-10 py-3 text-ink bg-white/95 border border-neutral-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--theme-accent)] focus:border-transparent transition-all duration-200 appearance-none cursor-pointer"
      >
        {articleTypes.map(type => (
          <option value={type.value}>{type.label}</option>
        ))}
      </select>
      
      <!-- Prefecture Filter -->
      <select
        id="prefecture-filter-desktop"
        class="select-field w-full sm:w-auto pl-4 pr-10 py-3 text-ink bg-white/95 border border-neutral-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--theme-accent)] focus:border-transparent transition-all duration-200 appearance-none cursor-pointer"
      >
        {prefectures.map(prefecture => (
          <option value={prefecture.code}>{prefecture.name}</option>
        ))}
      </select>
    </div>

    <!-- Desktop Buttons -->
    <div class="flex gap-2">
      <!-- Search Button -->
      <button
        id="search-button-desktop"
        class="cta-search px-6 py-3 bg-[var(--theme-accent)] text-white font-semibold rounded-2xl shadow-md hover:bg-[var(--theme-accent)]/90 focus:outline-none focus:ring-2 focus:ring-[var(--theme-accent)] focus:ring-offset-2 transition-all duration-200 transform hover:scale-105"
      >
        <span class="hidden sm:inline">{getUILabel(lang, 'search')}</span>
        <svg class="h-5 w-5 sm:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </button>
      
      <!-- Reset Button -->
      <button
        id="reset-button-desktop"
        class="cta-reset px-4 py-3 bg-neutral-100/90 text-neutral-700 font-medium rounded-2xl shadow-sm hover:bg-neutral-200 focus:outline-none focus:ring-2 focus:ring-neutral-400 focus:ring-offset-2 transition-all duration-200 transform hover:scale-105"
        title={getUILabel(lang, 'reset')}
      >
        <span class="hidden sm:inline">{getUILabel(lang, 'reset')}</span>
        <svg class="h-5 w-5 sm:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
      </button>
    </div>
  </div>
</div>

<!-- „Ç´„Çπ„Çø„É†Áü¢Âç∞„Ç¢„Ç§„Ç≥„É≥„ÇíCSS„ÅßËøΩÂä† -->
<style>
  /* select„Éú„ÉÉ„ÇØ„Çπ„ÅÆÁü¢Âç∞„Çí„Ç´„Çπ„Çø„Éû„Ç§„Ç∫ */
  #type-filter, #prefecture-filter, #type-filter-desktop, #prefecture-filter-desktop {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.75rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
  }
  
  /* Filter panel max height when expanded */
  .filter-expanded {
    max-height: 320px !important;
  }

  /* Harmony with hero: soft shadows, subtle borders */
  .search-card {
    box-shadow: 0 8px 24px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
  }

  .search-field, .select-field {
    transition: box-shadow 0.2s ease, transform 0.2s ease;
  }

  .search-field:focus, .select-field:focus {
    box-shadow: 0 8px 20px rgba(166,30,34,0.10);
  }

  .cta-search {
    box-shadow: 0 6px 14px rgba(166,30,34,0.25);
  }

  .cta-search:hover {
    box-shadow: 0 10px 20px rgba(166,30,34,0.28);
  }

  .cta-reset {
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }
</style>

<script>
  const FILTER_STORAGE_KEY = 'blogFilterState';
  // „É´„Éº„ÉàË¶ÅÁ¥†„Åã„Çâ i18n ÊñáË®Ä„ÇíÂèñÂæóÔºà„Çµ„Éº„ÉêÊ±∫ÂÆöÂÄ§„Çí data-* „ÅßÂèó„ÅëÊ∏°„ÅóÔºâ
  const ROOT_EL = document.getElementById('search-filter') as HTMLElement | null;
  
  // Singleton instance to prevent multiple initializations
  let searchFilterInstance = null;
  
  class SearchFilter {
    // „Å©„ÅÆÂÖ•Âäõ„ÅåÊúÄÂæå„Å´Â§âÊõ¥„Åï„Çå„Åü„Åã„Çí‰øùÊåÅÔºàÂèåÊñπÂêëÂêåÊúü„ÅÆÁ´∂ÂêàÂõûÈÅøÔºâ
    lastChanged: 'search-mobile' | 'search-desktop' | 'type-mobile' | 'type-desktop' | 'pref-mobile' | 'pref-desktop' | null
    // IMEÂ§âÊèõ‰∏≠„Éï„É©„Ç∞ÔºàÊó•Êú¨Ë™ûÂÖ•ÂäõÂØæÂøúÔºâ
    isComposing: boolean
    constructor() {
      // Prevent multiple instances
      if (searchFilterInstance) {
        return searchFilterInstance;
      }
      
      // Mobile elements
      this.searchInput = document.getElementById('search-input') as HTMLInputElement
      this.typeFilter = document.getElementById('type-filter') as HTMLSelectElement
      this.prefectureFilter = document.getElementById('prefecture-filter') as HTMLSelectElement
      this.searchButton = document.getElementById('search-button') as HTMLButtonElement
      this.resetButton = document.getElementById('reset-button') as HTMLButtonElement
      
      // Desktop elements
      this.searchInputDesktop = document.getElementById('search-input-desktop') as HTMLInputElement
      this.typeFilterDesktop = document.getElementById('type-filter-desktop') as HTMLSelectElement
      this.prefectureFilterDesktop = document.getElementById('prefecture-filter-desktop') as HTMLSelectElement
      this.searchButtonDesktop = document.getElementById('search-button-desktop') as HTMLButtonElement
      this.resetButtonDesktop = document.getElementById('reset-button-desktop') as HTMLButtonElement
      
      // Mobile accordion elements
      this.filterToggle = document.getElementById('filter-toggle') as HTMLButtonElement
      this.filterPanel = document.getElementById('filter-panel') as HTMLDivElement
      this.filterIcon = document.getElementById('filter-icon') as SVGElement
      
      // „Éö„Éº„Ç∏„É≥„Ç∞ÂØæÂøú: ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏„ÅÆË®ò‰∫ã„ÅÆ„Åø„ÇíÂØæË±°„Å´„Åô„Çã
      this.articles = Array.from(document.querySelectorAll('[data-article]'))
      this.totalArticles = this.articles.length
      
      // Flag to prevent sync loops
      this.syncing = false
      
      // ÂàùÊúüÂÄ§
      this.lastChanged = null
      this.isComposing = false
      this.bindEvents()
      // „Çª„ÉÉ„Ç∑„Éß„É≥„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâÁä∂ÊÖã„ÇíÂæ©ÂÖÉ
      this.loadState()
      // „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Çµ„Ç§„Éâ„ÅÆËá™Âãï„Éï„Ç£„É´„Çø„É™„É≥„Ç∞„ÅØË°å„Çè„Å™„ÅÑÔºàÊ§úÁ¥¢„Éö„Éº„Ç∏ÈÅ∑ÁßªÊñπÂºèÔºâ
      // this.filterArticles()
      
      // Store singleton instance
      searchFilterInstance = this;
    }

    bindEvents() {
      // Mobile filter accordion toggle
      this.filterToggle?.addEventListener('click', () => this.toggleFilters())
      
      // Mobile events
      this.searchInput?.addEventListener('compositionstart', () => { this.isComposing = true; this.lastChanged = 'search-mobile' })
      this.searchInput?.addEventListener('compositionend', () => { this.isComposing = false; this.lastChanged = 'search-mobile'; this.syncAndFilter() })
      this.searchInput?.addEventListener('input', () => { this.lastChanged = 'search-mobile'; this.syncAndFilter() })
      this.typeFilter?.addEventListener('change', () => { this.lastChanged = 'type-mobile'; this.syncAndFilter() })
      this.prefectureFilter?.addEventListener('change', () => { this.lastChanged = 'pref-mobile'; this.syncAndFilter() })
      this.searchButton?.addEventListener('click', () => this.filterArticles())
      this.resetButton?.addEventListener('click', () => this.resetFilters())
      this.searchInput?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !this.isComposing) {
          this.filterArticles()
        }
      })
      
      // Desktop events
      this.searchInputDesktop?.addEventListener('compositionstart', () => { this.isComposing = true; this.lastChanged = 'search-desktop' })
      this.searchInputDesktop?.addEventListener('compositionend', () => { this.isComposing = false; this.lastChanged = 'search-desktop'; this.syncAndFilter() })
      this.searchInputDesktop?.addEventListener('input', () => { this.lastChanged = 'search-desktop'; this.syncAndFilter() })
      this.typeFilterDesktop?.addEventListener('change', () => { this.lastChanged = 'type-desktop'; this.syncAndFilter() })
      this.prefectureFilterDesktop?.addEventListener('change', () => { this.lastChanged = 'pref-desktop'; this.syncAndFilter() })
      this.searchButtonDesktop?.addEventListener('click', () => this.filterArticles())
      this.resetButtonDesktop?.addEventListener('click', () => this.resetFilters())
      this.searchInputDesktop?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !this.isComposing) {
          this.filterArticles()
        }
      })
    }
    
    toggleFilters() {
      if (this.filterPanel && this.filterIcon) {
        const isExpanded = this.filterPanel.classList.contains('filter-expanded')
        
        if (isExpanded) {
          this.filterPanel.classList.remove('filter-expanded')
          this.filterIcon.style.transform = 'rotate(0deg)'
        } else {
          this.filterPanel.classList.add('filter-expanded')
          this.filterIcon.style.transform = 'rotate(180deg)'
        }
      }
    }
    
    // Sync mobile and desktop inputs
    syncAndFilter() {
      // Prevent infinite sync loops
      if (this.syncing) return;
      // Êó•Êú¨Ë™ûIMEÂÖ•Âäõ‰∏≠„ÅØÂêåÊúü„Éª„Éï„Ç£„É´„Çø„Çí‰∏ÄÊôÇÂÅúÊ≠¢ÔºàÁ¢∫ÂÆöÊôÇ„Å´ÂÆüË°åÔºâ
      if (this.isComposing && (this.lastChanged === 'search-mobile' || this.lastChanged === 'search-desktop')) {
        return;
      }
      
      this.syncing = true;
      this.syncInputs()
      // ÂÖ•ÂäõÂêåÊúüÊôÇ„ÅØÈÅ∑Áßª„Åõ„ÅöÁä∂ÊÖã„ÅÆ„Åø‰øùÂ≠ò
      this.saveState()
      this.syncing = false;
    }
    
    syncInputs() {
      // Sync search input (directional)
      const mobileValue = this.searchInput?.value || ''
      const desktopValue = this.searchInputDesktop?.value || ''
      let unifiedSearch = ''
      if (this.lastChanged === 'search-desktop') {
        unifiedSearch = desktopValue
      } else if (this.lastChanged === 'search-mobile') {
        unifiedSearch = mobileValue
      } else {
        unifiedSearch = desktopValue || mobileValue
      }
      if (this.lastChanged === 'search-mobile') {
        // ÂÖ•ÂäõÂÖÉÔºà„É¢„Éê„Ç§„É´Ôºâ„Å∏„ÅÆÊõ∏„ÅçÊàª„Åó„ÅØÈÅø„Åë„ÄÅ„Éá„Çπ„ÇØ„Éà„ÉÉ„Éó„ÅÆ„ÅøÂêåÊúü
        if (this.searchInputDesktop) this.searchInputDesktop.value = unifiedSearch
      } else if (this.lastChanged === 'search-desktop') {
        // ÂÖ•ÂäõÂÖÉÔºà„Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÔºâ„Å∏„ÅÆÊõ∏„ÅçÊàª„Åó„ÅØÈÅø„Åë„ÄÅ„É¢„Éê„Ç§„É´„ÅÆ„ÅøÂêåÊúü
        if (this.searchInput) this.searchInput.value = unifiedSearch
      } else {
        if (this.searchInput) this.searchInput.value = unifiedSearch
        if (this.searchInputDesktop) this.searchInputDesktop.value = unifiedSearch
      }

      // Sync type filter (directional)
      const mobileType = this.typeFilter?.value || ''
      const desktopType = this.typeFilterDesktop?.value || ''
      let unifiedType = ''
      if (this.lastChanged === 'type-desktop') {
        unifiedType = desktopType
      } else if (this.lastChanged === 'type-mobile') {
        unifiedType = mobileType
      } else {
        unifiedType = desktopType || mobileType
      }
      if (this.lastChanged === 'type-mobile') {
        if (this.typeFilterDesktop) this.typeFilterDesktop.value = unifiedType
      } else if (this.lastChanged === 'type-desktop') {
        if (this.typeFilter) this.typeFilter.value = unifiedType
      } else {
        if (this.typeFilter) this.typeFilter.value = unifiedType
        if (this.typeFilterDesktop) this.typeFilterDesktop.value = unifiedType
      }

      // Sync prefecture filter (directional)
      const mobilePrefecture = this.prefectureFilter?.value || ''
      const desktopPrefecture = this.prefectureFilterDesktop?.value || ''
      let unifiedPref = ''
      if (this.lastChanged === 'pref-desktop') {
        unifiedPref = desktopPrefecture
      } else if (this.lastChanged === 'pref-mobile') {
        unifiedPref = mobilePrefecture
      } else {
        unifiedPref = desktopPrefecture || mobilePrefecture
      }
      if (this.lastChanged === 'pref-mobile') {
        if (this.prefectureFilterDesktop) this.prefectureFilterDesktop.value = unifiedPref
      } else if (this.lastChanged === 'pref-desktop') {
        if (this.prefectureFilter) this.prefectureFilter.value = unifiedPref
      } else {
        if (this.prefectureFilter) this.prefectureFilter.value = unifiedPref
        if (this.prefectureFilterDesktop) this.prefectureFilterDesktop.value = unifiedPref
      }
    }

    filterArticles() {
      // ÂÖ•ÂäõÂÄ§„ÇíÂèñÂæóÔºà„Åù„ÅÆ„Åæ„ÅæURL„Å´Ëºâ„Åõ„Çã„Åü„ÇÅÂ∞èÊñáÂ≠óÂåñ„Åó„Å™„ÅÑÔºâ
      const searchTerm = this.searchInput?.value || this.searchInputDesktop?.value || ''
      const selectedType = this.typeFilter?.value || this.typeFilterDesktop?.value || ''
      const selectedPrefecture = this.prefectureFilter?.value || this.prefectureFilterDesktop?.value || ''

      // ÁèæÂú®„ÅÆË®ÄË™û„ÇíÂèñÂæó
      const currentLang = ROOT_EL?.dataset.lang || 'ja'

      // Áä∂ÊÖã„Çí‰øùÂ≠ò
      this.saveState()

      // Ê§úÁ¥¢Êù°‰ª∂„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÊ§úÁ¥¢„Éö„Éº„Ç∏„Å∏ÈÅ∑Áßª
      if (searchTerm || selectedType || selectedPrefecture) {
        const params = new URLSearchParams()
        if (searchTerm) params.set('q', searchTerm)
        if (selectedType) params.set('type', selectedType)
        if (selectedPrefecture) params.set('prefecture', selectedPrefecture)
        
        // Ë®ÄË™û„Å´Âøú„Åò„Å¶ÈÅ©Âàá„Å™Ê§úÁ¥¢„Éö„Éº„Ç∏„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
        const searchPath = currentLang === 'ja' ? '/search' : `/${currentLang}/search`
        window.location.href = `${searchPath}?${params.toString()}`
        return
      }

      // Êù°‰ª∂„ÅåÁ©∫„ÅßÊ§úÁ¥¢„Éö„Éº„Ç∏„Å´„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Éà„ÉÉ„Éó„Å∏
      const currentPath = window.location.pathname
      if (currentPath === '/search' || currentPath.endsWith('/search')) {
        const homePath = currentLang === 'ja' ? '/' : `/${currentLang}/`
        window.location.href = homePath
      }
    }

    resetFilters() {
      // ÁèæÂú®„ÅÆË®ÄË™û„ÇíÂèñÂæó
      const currentLang = ROOT_EL?.dataset.lang || 'ja'
      
      // Ê§úÁ¥¢„Éö„Éº„Ç∏„Å´„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Éà„ÉÉ„Éó„Éö„Éº„Ç∏„Å´Êàª„Çã
      const currentPath = window.location.pathname
      if (currentPath === '/search' || currentPath.endsWith('/search')) {
        const homePath = currentLang === 'ja' ? '/' : `/${currentLang}/`
        window.location.href = homePath
        return
      }
      // Reset mobile inputs
      if (this.searchInput) {
        this.searchInput.value = ''
      }
      if (this.typeFilter) {
        this.typeFilter.selectedIndex = 0
      }
      if (this.prefectureFilter) {
        this.prefectureFilter.selectedIndex = 0
      }
      
      // Reset desktop inputs
      if (this.searchInputDesktop) {
        this.searchInputDesktop.value = ''
      }
      if (this.typeFilterDesktop) {
        this.typeFilterDesktop.selectedIndex = 0
      }
      if (this.prefectureFilterDesktop) {
        this.prefectureFilterDesktop.selectedIndex = 0
      }
      
      // ÂÖ®„Å¶„ÅÆË®ò‰∫ã„ÇíË°®Á§∫
      this.articles.forEach((article) => {
        const element = article as HTMLElement
        element.style.display = 'block'
        element.style.animation = 'fadeIn 0.3s ease-in-out'
      })
      
      // „ÄåÁµêÊûú„Å™„Åó„Äç„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈùûË°®Á§∫
      const noResultsEl = document.getElementById('no-results-message')
      if (noResultsEl) {
        noResultsEl.style.display = 'none'
      }
      // Áä∂ÊÖã„Çí‰øùÂ≠ò
      this.saveState()
    }

    saveState() {
      const payload = {
        searchTerm: this.searchInput?.value || this.searchInputDesktop?.value || '',
        selectedType: this.typeFilter?.value || this.typeFilterDesktop?.value || '',
        selectedPrefecture: this.prefectureFilter?.value || this.prefectureFilterDesktop?.value || ''
      }
      sessionStorage.setItem(FILTER_STORAGE_KEY, JSON.stringify(payload))
    }

    loadState() {
      try {
        const saved = JSON.parse(sessionStorage.getItem(FILTER_STORAGE_KEY) || '{}')
        
        // Load into both mobile and desktop inputs
        if (saved.searchTerm !== undefined) {
          if (this.searchInput) this.searchInput.value = saved.searchTerm
          if (this.searchInputDesktop) this.searchInputDesktop.value = saved.searchTerm
        }
        if (saved.selectedType !== undefined) {
          if (this.typeFilter) this.typeFilter.value = saved.selectedType
          if (this.typeFilterDesktop) this.typeFilterDesktop.value = saved.selectedType
        }
        if (saved.selectedPrefecture !== undefined) {
          if (this.prefectureFilter) this.prefectureFilter.value = saved.selectedPrefecture
          if (this.prefectureFilterDesktop) this.prefectureFilterDesktop.value = saved.selectedPrefecture
        }
      } catch (e) {
        console.error('Failed to load filter state', e)
      }
    }

    updatePageInfo() {
      // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥ÂØæÂøú: ÁèæÂú®„Éö„Éº„Ç∏„ÅÆË®ò‰∫ãÊï∞ÊÉÖÂ†±„ÇíË°®Á§∫
      const pageInfoEl = document.getElementById('page-info')
      if (pageInfoEl) {
        const infoText = `${this.totalArticles} articles on this page`
        pageInfoEl.textContent = infoText
      }
    }

    updateNoResultsMessage(visibleCount: number) {
      let noResultsEl = document.getElementById('no-results-message')
      
      if (visibleCount === 0) {
        if (!noResultsEl) {
          noResultsEl = document.createElement('div')
          noResultsEl.id = 'no-results-message'
          noResultsEl.className = 'text-center py-16 bg-white rounded-2xl shadow-lg border border-gray-100'
          const noResultsTitle = ROOT_EL?.dataset.noResultsTitle || ''
          const noResultsSubtitle = ROOT_EL?.dataset.noResultsSubtitle || ''
          
          noResultsEl.innerHTML = `
            <div class="text-6xl mb-4">üîç</div>
            <p class="text-gray-500 text-xl mb-2">${noResultsTitle}</p>
            <p class="text-gray-400">${noResultsSubtitle}</p>
          `
          
          const articlesContainer = document.querySelector('#articles .grid')
          articlesContainer?.parentNode?.appendChild(noResultsEl)
        }
        noResultsEl.style.display = 'block'
      } else {
        if (noResultsEl) {
          noResultsEl.style.display = 'none'
        }
      }
    }
  }

  // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´ÂàùÊúüÂåñ (DOMContentLoaded ÂØæÂøú)
  function initializeSearchFilter() {
    // Only initialize if elements exist and no instance exists yet
    if (!searchFilterInstance && (document.getElementById('search-input') || document.getElementById('search-input-desktop'))) {
      new SearchFilter()
    }
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeSearchFilter)
  } else {
    initializeSearchFilter()
  }
</script>

<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>