---
import { getUILabel, DEFAULT_LANGUAGE } from '../lib/i18n'
import { getPrefecturesForLanguage } from '../lib/prefectures'

export interface Props {
  lang?: string
}

const { lang = DEFAULT_LANGUAGE } = Astro.props

// è¨˜äº‹ã‚¿ã‚¤ãƒ—ã®å®šç¾©
const articleTypes = [
  { value: '', label: getUILabel(lang, 'allTypes') },
  { value: 'spot', label: getUILabel(lang, 'spot') },
  { value: 'food', label: getUILabel(lang, 'food') },
  { value: 'transport', label: getUILabel(lang, 'transport') },
  { value: 'hotel', label: getUILabel(lang, 'hotel') },
  { value: 'note', label: getUILabel(lang, 'note') }
]

// å…¨47éƒ½é“åºœçœŒã®å®šç¾©ï¼ˆå¤šè¨€èªå¯¾å¿œï¼‰
const allPrefectures = getPrefecturesForLanguage(lang)
const prefectures = [
  { code: '', name: getUILabel(lang, 'allPrefectures') },
  ...allPrefectures.map(p => ({ code: p.code, name: p.name }))
]
---

<div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 mb-8">
  <div class="flex flex-col lg:flex-row gap-4">
    <!-- æ¤œç´¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
    <div class="flex-1">
      <div class="relative">
        <input
          type="text"
          id="search-input"
          placeholder={getUILabel(lang, 'searchPlaceholder')}
          class="w-full pl-12 pr-4 py-3 text-gray-700 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all duration-200"
        />
        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
          <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>
      </div>
    </div>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é¸æŠ -->
    <div class="flex flex-col sm:flex-row gap-4 flex-shrink-0">
      <!-- è¨˜äº‹ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
      <select
        id="type-filter"
        class="w-full sm:w-auto pl-4 pr-10 py-3 text-gray-700 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all duration-200 appearance-none cursor-pointer"
      >
        {articleTypes.map(type => (
          <option value={type.value}>{type.label}</option>
        ))}
      </select>
      
      <!-- éƒ½é“åºœçœŒãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
      <select
        id="prefecture-filter"
        class="w-full sm:w-auto pl-4 pr-10 py-3 text-gray-700 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all duration-200 appearance-none cursor-pointer"
      >
        {prefectures.map(prefecture => (
          <option value={prefecture.code}>{prefecture.name}</option>
        ))}
      </select>
    </div>

    <!-- ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ— -->
    <div class="flex gap-2">
      <!-- æ¤œç´¢ãƒœã‚¿ãƒ³ -->
      <button
        id="search-button"
        class="px-6 py-3 bg-gradient-to-r from-brand-500 to-brand-600 text-white font-medium rounded-xl hover:from-brand-600 hover:to-brand-700 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:ring-offset-2 transition-all duration-200 transform hover:scale-105"
      >
        <span class="hidden sm:inline">{getUILabel(lang, 'search')}</span>
        <svg class="h-5 w-5 sm:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </button>
      
      <!-- ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ -->
      <button
        id="reset-button"
        class="px-4 py-3 bg-gray-500 hover:bg-gray-600 text-white font-medium rounded-xl focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-all duration-200 transform hover:scale-105"
        title={getUILabel(lang, 'reset')}
      >
        <span class="hidden sm:inline">{getUILabel(lang, 'reset')}</span>
        <svg class="h-5 w-5 sm:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
      </button>
    </div>
  </div>
</div>

<!-- ã‚«ã‚¹ã‚¿ãƒ çŸ¢å°ã‚¢ã‚¤ã‚³ãƒ³ã‚’CSSã§è¿½åŠ  -->
<style>
  /* selectãƒœãƒƒã‚¯ã‚¹ã®çŸ¢å°ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
  #type-filter, #prefecture-filter {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.75rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
  }
</style>

<script>
  class SearchFilter {
    constructor() {
      this.searchInput = document.getElementById('search-input') as HTMLInputElement
      this.typeFilter = document.getElementById('type-filter') as HTMLSelectElement
      this.prefectureFilter = document.getElementById('prefecture-filter') as HTMLSelectElement
      this.searchButton = document.getElementById('search-button') as HTMLButtonElement
      this.resetButton = document.getElementById('reset-button') as HTMLButtonElement
      this.articles = Array.from(document.querySelectorAll('[data-article]'))
      
      this.bindEvents()
    }

    bindEvents() {
      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œç´¢
      this.searchInput?.addEventListener('input', () => this.filterArticles())
      this.typeFilter?.addEventListener('change', () => this.filterArticles())
      this.prefectureFilter?.addEventListener('change', () => this.filterArticles())
      
      // æ¤œç´¢ãƒœã‚¿ãƒ³
      this.searchButton?.addEventListener('click', () => this.filterArticles())
      
      // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
      this.resetButton?.addEventListener('click', () => this.resetFilters())
      
      // Enterã‚­ãƒ¼ã§æ¤œç´¢
      this.searchInput?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          this.filterArticles()
        }
      })
    }

    filterArticles() {
      const searchTerm = this.searchInput?.value.toLowerCase() || ''
      const selectedType = this.typeFilter?.value || ''
      const selectedPrefecture = this.prefectureFilter?.value || ''
      
      let visibleCount = 0
      
      this.articles.forEach((article) => {
        const element = article as HTMLElement
        const title = element.dataset.title?.toLowerCase() || ''
        const type = element.dataset.type || ''
        const placeName = element.dataset.placeName?.toLowerCase() || ''
        const prefecture = element.dataset.prefecture || ''
        const bodyText = element.dataset.bodyText?.toLowerCase() || ''
        
        const matchesSearch = !searchTerm || 
          title.includes(searchTerm) || 
          placeName.includes(searchTerm) ||
          bodyText.includes(searchTerm)
        
        const matchesType = !selectedType || type === selectedType
        const matchesPrefecture = !selectedPrefecture || prefecture === selectedPrefecture
        
        const shouldShow = matchesSearch && matchesType && matchesPrefecture
        
        if (shouldShow) {
          element.style.display = 'block'
          element.style.animation = 'fadeIn 0.3s ease-in-out'
          visibleCount++
        } else {
          element.style.display = 'none'
        }
      })
      
      // çµæœãŒ0ä»¶ã®å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
      this.updateNoResultsMessage(visibleCount)
    }

    resetFilters() {
      // å…¨ã¦ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
      if (this.searchInput) {
        this.searchInput.value = ''
      }
      if (this.typeFilter) {
        this.typeFilter.selectedIndex = 0
      }
      if (this.prefectureFilter) {
        this.prefectureFilter.selectedIndex = 0
      }
      
      // å…¨ã¦ã®è¨˜äº‹ã‚’è¡¨ç¤º
      this.articles.forEach((article) => {
        const element = article as HTMLElement
        element.style.display = 'block'
        element.style.animation = 'fadeIn 0.3s ease-in-out'
      })
      
      // ã€Œçµæœãªã—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
      const noResultsEl = document.getElementById('no-results-message')
      if (noResultsEl) {
        noResultsEl.style.display = 'none'
      }
    }

    updateNoResultsMessage(visibleCount: number) {
      let noResultsEl = document.getElementById('no-results-message')
      
      if (visibleCount === 0) {
        if (!noResultsEl) {
          noResultsEl = document.createElement('div')
          noResultsEl.id = 'no-results-message'
          noResultsEl.className = 'text-center py-16 bg-white rounded-2xl shadow-lg border border-gray-100'
          const noResultsTitle = {
            'ja': 'æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ',
            'en': 'No search results found',
            'zh-cn': 'æœªæ‰¾åˆ°æœç´¢ç»“æœ',
            'zh-tw': 'æœªæ‰¾åˆ°æœå°‹çµæœ',
            'ko': 'ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
            'th': 'à¹„à¸¡à¹ˆà¸à¸šà¸œà¸¥à¸à¸²à¸£à¸„à¹‰à¸™à¸«à¸²',
            'vi': 'KhÃ´ng tÃ¬m tháº¥y káº¿t quáº£ tÃ¬m kiáº¿m',
            'id': 'Tidak ditemukan hasil pencarian',
            'ms': 'Tiada hasil carian ditemui',
            'tl': 'Walang nahanap na resulta',
            'fr': 'Aucun rÃ©sultat trouvÃ©',
            'de': 'Keine Suchergebnisse gefunden',
            'es': 'No se encontraron resultados',
            'it': 'Nessun risultato trovato',
            'pt': 'Nenhum resultado encontrado',
            'ru': 'Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹',
            'ar': 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬',
            'hi': 'à¤•à¥‹à¤ˆ à¤–à¥‹à¤œ à¤ªà¤°à¤¿à¤£à¤¾à¤® à¤¨à¤¹à¥€à¤‚ à¤®à¤¿à¤²à¤¾',
            'tr': 'Arama sonucu bulunamadÄ±',
            'pt-br': 'Nenhum resultado encontrado'
          }
          
          const noResultsSubtitle = {
            'ja': 'ä»–ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ã—ã¦ã¿ã¦ãã ã•ã„',
            'en': 'Try searching with different keywords',
            'zh-cn': 'è¯·å°è¯•ä½¿ç”¨å…¶ä»–å…³é”®è¯æœç´¢',
            'zh-tw': 'è«‹å˜—è©¦ä½¿ç”¨å…¶ä»–é—œéµè©æœå°‹',
            'ko': 'ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”',
            'th': 'à¸¥à¸­à¸‡à¸„à¹‰à¸™à¸«à¸²à¸”à¹‰à¸§à¸¢à¸„à¸³à¸­à¸·à¹ˆà¸™',
            'vi': 'Thá»­ tÃ¬m kiáº¿m vá»›i tá»« khÃ³a khÃ¡c',
            'id': 'Coba cari dengan kata kunci lain',
            'ms': 'Cuba cari dengan kata kunci lain',
            'tl': 'Subukan maghanap gamit ang ibang keyword',
            'fr': 'Essayez avec d\'autres mots-clÃ©s',
            'de': 'Versuchen Sie es mit anderen Suchbegriffen',
            'es': 'Intenta buscar con otras palabras clave',
            'it': 'Prova a cercare con altre parole chiave',
            'pt': 'Tente procurar com outras palavras-chave',
            'ru': 'ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ¸ÑĞº Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ğ¼Ğ¸ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğ¼Ğ¸ ÑĞ»Ğ¾Ğ²Ğ°Ğ¼Ğ¸',
            'ar': 'Ø¬Ø±Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø¨ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ© Ø£Ø®Ø±Ù‰',
            'hi': 'à¤…à¤¨à¥à¤¯ à¤•à¥€à¤µà¤°à¥à¤¡ à¤•à¥‡ à¤¸à¤¾à¤¥ à¤–à¥‹à¤œà¤¨à¥‡ à¤•à¤¾ à¤ªà¥à¤°à¤¯à¤¾à¤¸ à¤•à¤°à¥‡à¤‚',
            'tr': 'BaÅŸka anahtar kelimelerle arama yapmayÄ± deneyin',
            'pt-br': 'Tente buscar com outras palavras-chave'
          }
          
          const currentLang = document.documentElement.lang || 'ja'
          
          noResultsEl.innerHTML = `
            <div class="text-6xl mb-4">ğŸ”</div>
            <p class="text-gray-500 text-xl mb-2">${noResultsTitle[currentLang] || noResultsTitle['ja']}</p>
            <p class="text-gray-400">${noResultsSubtitle[currentLang] || noResultsSubtitle['ja']}</p>
          `
          
          const articlesContainer = document.querySelector('#articles .columns-1, #articles .columns-2, #articles .columns-3')
          articlesContainer?.parentNode?.appendChild(noResultsEl)
        }
        noResultsEl.style.display = 'block'
      } else {
        if (noResultsEl) {
          noResultsEl.style.display = 'none'
        }
      }
    }
  }

  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', () => {
    new SearchFilter()
  })
</script>

<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>