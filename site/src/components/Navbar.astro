---
import { getUILabel, getLocalizedPath, ENABLED_LANGUAGES } from '../lib/i18n'

interface Props {
  lang: string
}

const { lang } = Astro.props

// è¨€èªåˆ¥ãƒ•ãƒ©ã‚°ã‚¨ãƒ¢ã‚¸
const languageFlags = {
  ja: 'ğŸ‡¯ğŸ‡µ',
  en: 'ğŸ‡ºğŸ‡¸',
  'zh-cn': 'ğŸ‡¨ğŸ‡³',
  'zh-tw': 'ğŸ‡¹ğŸ‡¼',
  ko: 'ğŸ‡°ğŸ‡·',
  th: 'ğŸ‡¹ğŸ‡­',
  vi: 'ğŸ‡»ğŸ‡³'
} as const

// ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ãƒ‘ã‚¹ã‚’å–å¾—ã—ã¦è¨€èªãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤å»
const currentPath = Astro.url.pathname

// è¨€èªãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤å»ã—ã¦ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ã‚’å–å¾—
function getBasePath(path: string): string {
  // æœ‰åŠ¹ãªè¨€èªã®ãƒªã‚¹ãƒˆã‚’ä½œæˆ
  const enabledLangCodes = ENABLED_LANGUAGES.map(l => l.id)
  
  // ãƒ‘ã‚¹ãŒè¨€èªãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã§å§‹ã¾ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  for (const langCode of enabledLangCodes) {
    if (langCode === 'ja') continue // æ—¥æœ¬èªã¯ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãªã—
    
    const prefix = `/${langCode}`
    if (path === prefix || path === `${prefix}/`) {
      return '/' // ãƒ«ãƒ¼ãƒˆãƒšãƒ¼ã‚¸
    }
    if (path.startsWith(`${prefix}/`)) {
      return path.slice(prefix.length) // è¨€èªãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤å»
    }
  }
  
  // è¨€èªãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãŒãªã„å ´åˆï¼ˆæ—¥æœ¬èªï¼‰
  return path
}

const basePath = getBasePath(currentPath)

// ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°ï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰
if (import.meta.env.DEV) {
  console.log('Navbar Debug:', {
    currentPath,
    basePath,
    currentLang: lang
  })
}
---

<nav class="sticky top-0 z-50 bg-white/95 backdrop-blur-md border-b border-gray-100 shadow-sm">
  <div class="max-w-7xl mx-auto px-4 py-3 sm:py-4 flex items-center justify-between">
    <!-- Logo -->
    <a href={lang === 'ja' ? '/' : `/${lang}/`} class="flex items-center gap-3 group">
      <div class="w-10 h-10 bg-gradient-to-br from-brand-500 to-accent-500 rounded-xl flex items-center justify-center shadow-lg group-hover:shadow-xl transition-all duration-300 group-hover:scale-110">
        <span class="text-white font-bold text-lg">æ—…</span>
      </div>
      <span class="text-2xl font-bold bg-gradient-to-r from-brand-400 to-accent-400 bg-clip-text text-transparent">
        {getUILabel(lang, 'siteTitle')}
      </span>
    </a>
    
    <!-- è¨€èªåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
    <div class="flex items-center gap-2">
      {ENABLED_LANGUAGES.map((language) => {
          const isCurrentLang = language.id === lang
          
          // è¨€èªé¸æŠæ™‚ã¯å¸¸ã«ãƒˆãƒƒãƒ—ç”»é¢ã«é·ç§»
          function generateLanguageUrl(targetLang: string): string {
            if (targetLang === 'ja') {
              return '/'
            } else {
              return `/${targetLang}/`
            }
          }
          
          const cleanPath = generateLanguageUrl(language.id)
          
          return (
            <a
              href={cleanPath}
              aria-label={`Switch to ${language.nativeName}`}
              role="button"
              tabindex="0"
              class={`
                relative group inline-flex items-center justify-center min-w-[3rem] h-12 px-3 rounded-lg transition-all duration-200 ease-out focus:ring-2 focus:ring-brand-400 focus:outline-none
                ${isCurrentLang 
                  ? 'bg-brand-500 text-white shadow-md' 
                  : 'bg-gray-100 text-gray-700 hover:bg-brand-50 hover:text-brand-600'
                }
              `}
              title={language.nativeName}
            >
              
              <div class="flex items-center gap-2">
                <!-- Flag Icon -->
                <span class="text-lg">
                  {languageFlags[language.id as keyof typeof languageFlags] || 'ğŸŒ'}
                </span>
                
                <!-- Language Text -->
                <span class="text-sm font-medium">
                  {language.shortName}
                </span>
              </div>
              
              
            </a>
          )
        })}
    </div>
  </div>
</nav>