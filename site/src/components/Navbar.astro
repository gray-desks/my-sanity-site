---
import { getUILabel, getLocalizedPath, ENABLED_LANGUAGES } from '../lib/i18n'

interface Props {
  lang: string
}

const { lang } = Astro.props

// è¨€èªåˆ¥ãƒ•ãƒ©ã‚°ã‚¨ãƒ¢ã‚¸
const languageFlags = {
  ja: 'ğŸ‡¯ğŸ‡µ',
  en: 'ğŸ‡ºğŸ‡¸',
  'zh-cn': 'ğŸ‡¨ğŸ‡³',
  'zh-tw': 'ğŸ‡¹ğŸ‡¼',
  ko: 'ğŸ‡°ğŸ‡·',
  th: 'ğŸ‡¹ğŸ‡­',
  vi: 'ğŸ‡»ğŸ‡³'
} as const

// ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ãƒ‘ã‚¹ã‚’å–å¾—ã—ã¦è¨€èªãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤å»
const currentPath = Astro.url.pathname

// è¨€èªãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤å»ã—ã¦ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ã‚’å–å¾—
function getBasePath(path: string): string {
  // æœ‰åŠ¹ãªè¨€èªã®ãƒªã‚¹ãƒˆã‚’ä½œæˆ
  const enabledLangCodes = ENABLED_LANGUAGES.map(l => l.id)
  
  // ãƒ‘ã‚¹ãŒè¨€èªãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã§å§‹ã¾ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  for (const langCode of enabledLangCodes) {
    if (langCode === 'ja') continue // æ—¥æœ¬èªã¯ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãªã—
    
    const prefix = `/${langCode}`
    if (path === prefix || path === `${prefix}/`) {
      return '/' // ãƒ«ãƒ¼ãƒˆãƒšãƒ¼ã‚¸
    }
    if (path.startsWith(`${prefix}/`)) {
      return path.slice(prefix.length) // è¨€èªãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤å»
    }
  }
  
  // è¨€èªãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãŒãªã„å ´åˆï¼ˆæ—¥æœ¬èªï¼‰
  return path
}

const basePath = getBasePath(currentPath)

// ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°ï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰
if (import.meta.env.DEV) {
  console.log('Navbar Debug:', {
    currentPath,
    basePath,
    currentLang: lang
  })
}
---

<nav class="sticky top-0 z-50 bg-white/95 backdrop-blur-md border-b border-gray-100 shadow-sm">
  <div class="max-w-7xl mx-auto px-4 py-3 sm:py-4 flex items-center justify-between">
    <!-- Logo -->
    <a href={lang === 'ja' ? '/' : `/${lang}/`} class="flex items-center gap-3 group">
      <div class="w-10 h-10 bg-gradient-to-br from-brand-500 to-accent-500 rounded-xl flex items-center justify-center shadow-lg group-hover:shadow-xl transition-all duration-300 group-hover:scale-110">
        <span class="text-white font-bold text-lg">æ—…</span>
      </div>
      <span class="text-2xl font-bold bg-gradient-to-r from-brand-400 to-accent-400 bg-clip-text text-transparent">
        {getUILabel(lang, 'siteTitle')}
      </span>
    </a>
    
    <!-- è¨€èªåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
    <div class="relative">
      <!-- Modern Language Selector -->
      <div class="flex items-center bg-white/90 backdrop-blur-sm rounded-2xl p-1 shadow-lg border border-white/50">
        {ENABLED_LANGUAGES.map((language) => {
          const isCurrentLang = language.id === lang
          
          // è¨€èªé¸æŠæ™‚ã¯å¸¸ã«ãƒˆãƒƒãƒ—ç”»é¢ã«é·ç§»
          function generateLanguageUrl(targetLang: string): string {
            if (targetLang === 'ja') {
              return '/'
            } else {
              return `/${targetLang}/`
            }
          }
          
          const cleanPath = generateLanguageUrl(language.id)
          
          return (
            <a
              href={cleanPath}
              class={`
                relative group inline-flex items-center justify-center w-10 h-10 sm:w-12 sm:h-10 sm:px-3 rounded-xl transition-all duration-300 ease-out
                ${isCurrentLang 
                  ? 'bg-gradient-to-br from-brand-500 via-brand-600 to-accent-500 text-white shadow-xl transform scale-110 z-10' 
                  : 'text-gray-500 hover:text-brand-600 hover:bg-brand-50/80 hover:scale-105 hover:shadow-md'
                }
              `}
              title={language.nativeName}
            >
              <!-- Background glow effect for active -->
              {isCurrentLang && (
                <div class="absolute inset-0 bg-gradient-to-br from-brand-400/30 to-accent-400/30 rounded-xl blur-lg scale-150 animate-pulse-slow"></div>
              )}
              
              <!-- Flag Icon -->
              <span class={`relative z-10 text-lg transition-transform duration-300 ${isCurrentLang ? 'animate-bounce' : 'group-hover:scale-110'}`}>
                {languageFlags[language.id as keyof typeof languageFlags] || 'ğŸŒ'}
              </span>
              
              <!-- Language Code (hidden on mobile) -->
              <span class="hidden sm:inline ml-1 text-xs font-bold uppercase tracking-wider relative z-10">
                {language.id}
              </span>
              
              <!-- Floating indicator for active -->
              {isCurrentLang && (
                <div class="absolute -top-1 -right-1 w-3 h-3 bg-gradient-to-br from-accent-400 to-secondary-400 rounded-full shadow-lg animate-pulse">
                  <div class="absolute inset-0.5 bg-white rounded-full"></div>
                </div>
              )}
              
              <!-- Hover shimmer effect -->
              <div class="absolute inset-0 rounded-xl bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-700 ease-out opacity-0 group-hover:opacity-100"></div>
            </a>
          )
        })}
      </div>
      
      <!-- Floating label for current language -->
      <div class="absolute -bottom-8 left-1/2 transform -translate-x-1/2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none">
        <div class="bg-gray-900/90 backdrop-blur-sm text-white text-xs px-2 py-1 rounded-lg shadow-lg">
          {ENABLED_LANGUAGES.find(l => l.id === lang)?.nativeName}
        </div>
      </div>
    </div>
  </div>
</nav>