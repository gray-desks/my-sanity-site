---
import { getUILabel, getLocalizedPath, ENABLED_LANGUAGES } from '../lib/i18n'

interface Props {
  lang: string
}

const { lang } = Astro.props

// è¨€èªåˆ¥ãƒ•ãƒ©ã‚°ã‚¨ãƒ¢ã‚¸
const languageFlags = {
  ja: 'ğŸ‡¯ğŸ‡µ',
  en: 'ğŸ‡ºğŸ‡¸',
  'zh-cn': 'ğŸ‡¨ğŸ‡³',
  'zh-tw': 'ğŸ‡¹ğŸ‡¼',
  ko: 'ğŸ‡°ğŸ‡·',
  th: 'ğŸ‡¹ğŸ‡­',
  vi: 'ğŸ‡»ğŸ‡³'
} as const

// ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ãƒ‘ã‚¹ã‚’å–å¾—ã—ã¦è¨€èªãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤å»
const currentPath = Astro.url.pathname

// è¨€èªãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤å»ã—ã¦ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ã‚’å–å¾—
function getBasePath(path: string): string {
  // æœ‰åŠ¹ãªè¨€èªã®ãƒªã‚¹ãƒˆã‚’ä½œæˆ
  const enabledLangCodes = ENABLED_LANGUAGES.map(l => l.id)
  
  // ãƒ‘ã‚¹ãŒè¨€èªãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã§å§‹ã¾ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  for (const langCode of enabledLangCodes) {
    if (langCode === 'ja') continue // æ—¥æœ¬èªã¯ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãªã—
    
    const prefix = `/${langCode}`
    if (path === prefix || path === `${prefix}/`) {
      return '/' // ãƒ«ãƒ¼ãƒˆãƒšãƒ¼ã‚¸
    }
    if (path.startsWith(`${prefix}/`)) {
      return path.slice(prefix.length) // è¨€èªãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤å»
    }
  }
  
  // è¨€èªãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãŒãªã„å ´åˆï¼ˆæ—¥æœ¬èªï¼‰
  return path
}

const basePath = getBasePath(currentPath)

// ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°ï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰
if (import.meta.env.DEV) {
  console.log('Navbar Debug:', {
    currentPath,
    basePath,
    currentLang: lang
  })
}
---

<nav class="sticky top-0 z-50 bg-white/95 backdrop-blur-md border-b border-gray-100 shadow-sm">
  <div class="max-w-7xl mx-auto px-4 py-3 sm:py-4 flex items-center justify-between">
    <!-- Logo -->
    <a href={lang === 'ja' ? '/' : `/${lang}/`} class="flex items-center gap-3 group">
      <div class="w-10 h-10 bg-gradient-to-br from-brand-500 to-accent-500 rounded-xl flex items-center justify-center shadow-lg group-hover:shadow-xl transition-all duration-300 group-hover:scale-110">
        <span class="text-white font-bold text-lg">æ—…</span>
      </div>
      <span class="text-2xl font-bold bg-gradient-to-r from-brand-400 to-accent-400 bg-clip-text text-transparent">
        {getUILabel(lang, 'siteTitle')}
      </span>
    </a>
    
    <!-- è¨€èªåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
    <div class="flex items-center flex-wrap gap-1 sm:gap-2">
      {ENABLED_LANGUAGES.map((language) => {
        const isCurrentLang = language.id === lang
        
        // è¨€èªåˆ¥URLã‚’ç”Ÿæˆ
        function generateLanguageUrl(targetLang: string, basePath: string): string {
          if (targetLang === 'ja') {
            // æ—¥æœ¬èªã®å ´åˆã¯è¨€èªãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãªã—
            return basePath || '/'
          } else {
            // ä»–è¨€èªã®å ´åˆã¯ /{lang}{basePath} å½¢å¼
            if (basePath === '/' || basePath === '') {
              return `/${targetLang}/`
            } else {
              // basePathãŒ/ã§å§‹ã¾ã£ã¦ã„ãªã„å ´åˆã¯è¿½åŠ 
              const normalizedBasePath = basePath.startsWith('/') ? basePath : `/${basePath}`
              return `/${targetLang}${normalizedBasePath}`
            }
          }
        }
        
        const cleanPath = generateLanguageUrl(language.id, basePath)
        
        return (
          <a
            href={cleanPath}
            class={`
              relative inline-flex items-center gap-1 px-2 py-1.5 sm:px-3 sm:py-2 rounded-lg text-sm font-medium transition-all duration-200 hover:transform hover:scale-105
              ${isCurrentLang 
                ? 'bg-gradient-to-r from-brand-500 to-accent-500 text-white shadow-lg ring-2 ring-brand-200' 
                : 'text-gray-600 hover:text-brand-600 hover:bg-brand-50 hover:shadow-md'
              }
            `}
            title={language.nativeName}
          >
            <span class="text-sm sm:text-base">{languageFlags[language.id as keyof typeof languageFlags] || 'ğŸŒ'}</span>
            <span class="hidden sm:inline text-xs font-bold uppercase tracking-wider">
              {language.id}
            </span>
            {isCurrentLang && (
              <div class="absolute -bottom-0.5 left-1/2 transform -translate-x-1/2 w-1 h-1 bg-white rounded-full animate-pulse"></div>
            )}
          </a>
        )
      })}
    </div>
  </div>
</nav>