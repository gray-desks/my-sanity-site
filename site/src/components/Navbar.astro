---
import { getUILabel, getLocalizedPath, ENABLED_LANGUAGES, ALL_LANGUAGES, DEFAULT_LANGUAGE } from '../lib/i18n'
import { langToCountry, type SupportedLanguage } from '../lib/langToCountry'
import FlagIcon from './FlagIcon.astro'

export interface Props {
  lang?: string
}

const { lang = DEFAULT_LANGUAGE } = Astro.props

// å…¨æœ‰åŠ¹è¨€èªã‚’è¡¨ç¤ºï¼ˆ20è¨€èªï¼‰
const availableLanguages = ENABLED_LANGUAGES
---

<nav class="sticky top-0 z-50 bg-base/80 backdrop-blur-md border-b border-border">
  <div class="max-w-7xl mx-auto px-4 py-3 sm:py-4 flex items-center justify-between">
    <!-- Logo -->
    <a 
      href={lang === 'ja' ? '/' : `/${lang}/`} 
      class="flex items-center gap-3 group"
      aria-label={`${getUILabel(lang, 'siteTitle')} - ${getUILabel(lang, 'home')}`}
    >
      <div class="w-10 h-10 bg-[var(--theme-accent)] rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
        <span class="text-white font-bold text-lg">æ—…</span>
      </div>
      <span class="text-2xl font-bold text-ink">
        {getUILabel(lang, 'siteTitle')}
      </span>
    </a>
    
    <!-- Navigation Links -->
    <div class="flex items-center gap-4">
      
      <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨è¨€èªãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
      <details class="sm:hidden relative" role="navigation" aria-label="Language selection">
        <summary 
          class="flex items-center gap-1 px-3 h-10 rounded-lg bg-ink/5 text-ink focus:ring-2 focus:ring-[var(--theme-accent)] cursor-pointer"
          aria-label="Select language"
          aria-expanded="false"
        >
          ğŸŒ
        </summary>
        <div class="absolute right-0 mt-2 w-48 bg-base rounded-lg shadow-lg border border-ink/10 z-50 max-h-80 overflow-y-auto">
          {availableLanguages.map((language) => (
            <a
              href={language.id === 'ja' ? '/' : `/${language.id}/`}
              class={`block px-4 py-2 text-sm hover:bg-[var(--theme-accent)]/10 transition-colors ${
                language.id === lang ? 'font-semibold text-[var(--theme-accent)] bg-[var(--theme-accent)]/5' : 'text-secondary'
              }`}}
              title={language.nativeName}
            >
              <FlagIcon code={langToCountry(language.id as SupportedLanguage)} size="xs" class="mr-2" />
              {language.nativeName}
            </a>
          ))}
        </div>
      </details>

      <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨è¨€èªãƒœã‚¿ãƒ³ï¼ˆ2æ®µè¡¨ç¤ºï¼‰ -->
      <div class="hidden sm:flex flex-col gap-1">
        <!-- 1æ®µç›®: 10è¨€èª -->
        <div class="flex items-center gap-1">
          {availableLanguages.slice(0, 10).map((language) => {
              const isCurrentLang = language.id === lang
              
              // è¨€èªé¸æŠæ™‚ã¯å¸¸ã«ãƒˆãƒƒãƒ—ç”»é¢ã«é·ç§»
              function generateLanguageUrl(targetLang: string): string {
                if (targetLang === 'ja') {
                  return '/'
                } else {
                  return `/${targetLang}/`
                }
              }
              
              const cleanPath = generateLanguageUrl(language.id)
              
              return (
                <a
                  href={cleanPath}
                  aria-label={`Switch to ${language.nativeName}`}
                  class={`
                     inline-flex items-center justify-center w-14 h-8 rounded-lg transition-all duration-200 ease-out focus:ring-2 focus:ring-[var(--theme-accent)] focus:outline-none shrink-0
                     ${isCurrentLang 
                      ? 'bg-[var(--theme-accent)] text-white shadow-md' 
                      : 'bg-ink/5 text-ink hover:bg-[var(--theme-accent)]/10 hover:text-[var(--theme-accent)]'
                    }
                  `}
                  title={language.nativeName}
                >
                  
                  <div class="flex items-center gap-1">
                    <!-- Flag Icon -->
                    <FlagIcon code={langToCountry(language.id as SupportedLanguage)} size="xs" />
                    
                    <!-- Language Text -->
                    <span class="text-xs font-medium">
                      {language.shortName}
                    </span>
                  </div>
                  
                </a>
              )
            })}
        </div>
        
        <!-- 2æ®µç›®: æ®‹ã‚Š10è¨€èª -->
        <div class="flex items-center gap-1">
          {availableLanguages.slice(10).map((language) => {
              const isCurrentLang = language.id === lang
              
              // è¨€èªé¸æŠæ™‚ã¯å¸¸ã«ãƒˆãƒƒãƒ—ç”»é¢ã«é·ç§»
              function generateLanguageUrl(targetLang: string): string {
                if (targetLang === 'ja') {
                  return '/'
                } else {
                  return `/${targetLang}/`
                }
              }
              
              const cleanPath = generateLanguageUrl(language.id)
              
              return (
                <a
                  href={cleanPath}
                  aria-label={`Switch to ${language.nativeName}`}
                  class={`
                     inline-flex items-center justify-center w-14 h-8 rounded-lg transition-all duration-200 ease-out focus:ring-2 focus:ring-[var(--theme-accent)] focus:outline-none shrink-0
                     ${isCurrentLang 
                      ? 'bg-[var(--theme-accent)] text-white shadow-md' 
                      : 'bg-ink/5 text-ink hover:bg-[var(--theme-accent)]/10 hover:text-[var(--theme-accent)]'
                    }
                  `}
                  title={language.nativeName}
                >
                  
                  <div class="flex items-center gap-1">
                    <!-- Flag Icon -->
                    <FlagIcon code={langToCountry(language.id as SupportedLanguage)} size="xs" />
                    
                    <!-- Language Text -->
                    <span class="text-xs font-medium">
                      {language.shortName}
                    </span>
                  </div>
                  
                </a>
              )
            })}
        </div>
      </div>
    </div>
  </div>
</nav>