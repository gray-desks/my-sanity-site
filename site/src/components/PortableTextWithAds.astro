---
import { PortableText } from 'astro-portabletext'
import AdSlot from './AdSlot.astro'
import { ADS_SLOTS } from '../config/ads'

export interface Props {
  value: any[]
  lang?: string
  showAds?: boolean
}

const { value, lang = 'ja', showAds = true } = Astro.props

// Find the position to insert the ad (after 2nd H2 or middle of content)
let insertAdAfterIndex = -1
let h2Count = 0

if (value && Array.isArray(value) && showAds) {
  for (let i = 0; i < value.length; i++) {
    const block = value[i]
    
    // Check if this is an H2 heading block
    if (block._type === 'block' && block.style === 'h2') {
      h2Count++
      
      // Insert ad after the second H2 heading
      if (h2Count === 2) {
        insertAdAfterIndex = i
        break
      }
    }
  }
  
  // If less than 2 H2s, insert ad in middle of content (but only if we have enough blocks)
  if (insertAdAfterIndex === -1 && value.length >= 4) {
    insertAdAfterIndex = Math.floor(value.length / 2)
  }
}

// Split content at the insertion point
const beforeAd = insertAdAfterIndex >= 0 ? value.slice(0, insertAdAfterIndex + 1) : value
const afterAd = insertAdAfterIndex >= 0 ? value.slice(insertAdAfterIndex + 1) : []
---

<div class="portable-text-with-ads">
  <!-- Content before ad -->
  <PortableText value={beforeAd} />
  
  <!-- In-Article Ad (only if we have content to split) -->
  {showAds && insertAdAfterIndex >= 0 && (
    <AdSlot
      slotId={ADS_SLOTS.POST_INARTICLE_1}
      format="in-article"
      reserveHeight={250}
      label={lang === 'en' ? 'Advertisement' : lang === 'zh-cn' ? '广告' : lang === 'zh-tw' ? '廣告' : lang === 'ko' ? '광고' : '广告'}
      class="my-8"
    />
  )}
  
  <!-- Content after ad -->
  {afterAd.length > 0 && (
    <PortableText value={afterAd} />
  )}
</div>

<style>
  .portable-text-with-ads {
    /* Ensure proper spacing and layout */
  }
</style>