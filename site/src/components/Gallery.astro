---
interface ImageAsset {
  asset: {
    _ref: string
    url?: string
  }
}

interface Props {
  images: ImageAsset[]
}

const { images } = Astro.props
const galleryId = `gallery-${Math.random().toString(36).substr(2, 9)}`
---

<div class="gallery-container" data-gallery-id={galleryId}>
  <div class="relative">
    <!-- Main image display -->
    <div class="gallery-main aspect-video bg-gray-100 rounded-lg overflow-hidden">
      <img 
        id={`${galleryId}-main`}
        src={`${images[0]?.asset?.url}?w=800&h=450&fit=crop&auto=format`}
        alt=""
        class="w-full h-full object-cover transition-opacity duration-300"
        loading="lazy"
        decoding="async"
      />
    </div>

    <!-- Navigation arrows -->
    {images.length > 1 && (
      <div class="absolute inset-y-0 left-0 flex items-center">
        <button 
          class="gallery-prev bg-black bg-opacity-50 text-white p-2 rounded-r-md hover:bg-opacity-75 transition-all"
          data-gallery={galleryId}
        >
          ←
        </button>
      </div>
    )}
    
    {images.length > 1 && (
      <div class="absolute inset-y-0 right-0 flex items-center">
        <button 
          class="gallery-next bg-black bg-opacity-50 text-white p-2 rounded-l-md hover:bg-opacity-75 transition-all"
          data-gallery={galleryId}
        >
          →
        </button>
      </div>
    )}

    <!-- Image counter -->
    {images.length > 1 && (
      <div class="absolute bottom-4 right-4 bg-black bg-opacity-50 text-white px-3 py-1 rounded-full text-sm">
        <span id={`${galleryId}-counter`}>1</span> / {images.length}
      </div>
    )}
  </div>

  <!-- Thumbnail strip -->
  {images.length > 1 && (
    <div class="mt-4 flex gap-2 overflow-x-auto pb-2">
      {images.map((image, index) => (
        <button
          class={`gallery-thumb flex-shrink-0 w-20 h-20 rounded-md overflow-hidden border-2 transition-all ${
            index === 0 ? 'border-blue-500' : 'border-transparent hover:border-gray-300'
          }`}
          data-gallery={galleryId}
          data-index={index}
        >
          <img 
            src={`${image.asset?.url}?w=80&h=80&fit=crop&auto=format`}
            alt=""
            class="w-full h-full object-cover"
            loading="lazy"
            decoding="async"
          />
        </button>
      ))}
    </div>
  )}
</div>

<script>
  class Gallery {
    constructor(container) {
      this.container = container
      this.galleryId = container.dataset.galleryId
      this.images = this.getImageUrls()
      this.currentIndex = 0
      
      this.mainImage = document.getElementById(`${this.galleryId}-main`)
      this.counter = document.getElementById(`${this.galleryId}-counter`)
      this.thumbs = container.querySelectorAll('.gallery-thumb')
      
      this.bindEvents()
      this.setupIntersectionObserver()
    }
    
    getImageUrls() {
      const thumbs = this.container.querySelectorAll('.gallery-thumb img')
      return Array.from(thumbs).map(img => {
        // Extract the base URL before query parameters and generate high-quality URL
        const baseUrl = img.src.split('?')[0]
        return `${baseUrl}?w=800&h=450&fit=crop&auto=format`
      })
    }
    
    bindEvents() {
      // Navigation buttons
      const prevBtn = this.container.querySelector('.gallery-prev')
      const nextBtn = this.container.querySelector('.gallery-next')
      
      prevBtn?.addEventListener('click', () => this.prev())
      nextBtn?.addEventListener('click', () => this.next())
      
      // Thumbnail clicks
      this.thumbs.forEach((thumb, index) => {
        thumb.addEventListener('click', () => this.goTo(index))
      })
      
      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (!this.isVisible()) return
        
        if (e.key === 'ArrowLeft') this.prev()
        if (e.key === 'ArrowRight') this.next()
      })
    }
    
    setupIntersectionObserver() {
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              this.loadImagesLazily()
            }
          })
        },
        { rootMargin: '50px' }
      )
      
      observer.observe(this.container)
    }
    
    loadImagesLazily() {
      const images = this.container.querySelectorAll('img[loading="lazy"]')
      images.forEach(img => {
        if (img.dataset.src) {
          img.src = img.dataset.src
          img.removeAttribute('data-src')
          img.removeAttribute('loading')
        }
      })
    }
    
    prev() {
      this.currentIndex = this.currentIndex > 0 ? this.currentIndex - 1 : this.images.length - 1
      this.updateDisplay()
    }
    
    next() {
      this.currentIndex = this.currentIndex < this.images.length - 1 ? this.currentIndex + 1 : 0
      this.updateDisplay()
    }
    
    goTo(index) {
      this.currentIndex = index
      this.updateDisplay()
    }
    
    updateDisplay() {
      // Update main image
      this.mainImage.style.opacity = '0'
      
      setTimeout(() => {
        this.mainImage.src = this.images[this.currentIndex]
        this.mainImage.style.opacity = '1'
      }, 150)
      
      // Update counter
      if (this.counter) {
        this.counter.textContent = this.currentIndex + 1
      }
      
      // Update thumbnail borders
      this.thumbs.forEach((thumb, index) => {
        if (index === this.currentIndex) {
          thumb.classList.remove('border-transparent')
          thumb.classList.add('border-blue-500')
        } else {
          thumb.classList.remove('border-blue-500')
          thumb.classList.add('border-transparent')
        }
      })
    }
    
    isVisible() {
      const rect = this.container.getBoundingClientRect()
      return rect.top < window.innerHeight && rect.bottom > 0
    }
  }
  
  // Initialize all galleries on the page
  document.addEventListener('DOMContentLoaded', () => {
    const galleries = document.querySelectorAll('.gallery-container')
    galleries.forEach(container => new Gallery(container))
  })
</script>

<style>
  .gallery-container {
    max-width: 100%;
  }
  
  .gallery-main img {
    transition: opacity 0.3s ease;
  }
  
  .gallery-thumb {
    cursor: pointer;
    transition: border-color 0.2s ease;
  }
  
  .gallery-thumb:hover {
    border-color: #cbd5e0;
  }
  
  .gallery-prev,
  .gallery-next {
    opacity: 0.8;
    transition: opacity 0.2s ease;
  }
  
  .gallery-prev:hover,
  .gallery-next:hover {
    opacity: 1;
  }
  
  /* Custom scrollbar for thumbnails */
  .gallery-container .overflow-x-auto::-webkit-scrollbar {
    height: 4px;
  }
  
  .gallery-container .overflow-x-auto::-webkit-scrollbar-track {
    background: #f1f5f9;
  }
  
  .gallery-container .overflow-x-auto::-webkit-scrollbar-thumb {
    background: #cbd5e0;
    border-radius: 4px;
  }
  
  .gallery-container .overflow-x-auto::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }
</style>