---
import type { Article } from '../lib/sanity'
import { DEFAULT_LANGUAGE } from '../lib/i18n'

interface Props {
  article: Article
  lang?: string
}

const { article, lang = DEFAULT_LANGUAGE } = Astro.props

const formatDate = (dateString: string) => {
  // å‹•çš„ãƒ­ã‚±ãƒ¼ãƒ«å–å¾—
  const localeMap: Record<string, string> = {
    ja: 'ja-JP',
    en: 'en-US',
    'zh-cn': 'zh-CN',
    'zh-tw': 'zh-TW',
    ko: 'ko-KR',
    th: 'th-TH',
    ar: 'ar-SA',
    ru: 'ru-RU',
    fr: 'fr-FR',
    de: 'de-DE',
    es: 'es-ES',
    it: 'it-IT',
    'pt-br': 'pt-BR',
    tr: 'tr-TR',
    nl: 'nl-NL',
    pl: 'pl-PL',
    sv: 'sv-SE',
    da: 'da-DK',
    fi: 'fi-FI',
    id: 'id-ID'
  }
  const locale = localeMap[lang] || 'en-US'
  
  return new Date(dateString).toLocaleDateString(locale, {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  })
}

const typeConfig = {
  spot: {
    emoji: 'ğŸ—¾',
    label: { 
      ja: 'ã‚¹ãƒãƒƒãƒˆ', 
      en: 'Spot',
      es: 'Lugar',
      fr: 'Lieu',
      de: 'Ort',
      it: 'Posto',
      'pt-br': 'Local',
      ru: 'ĞœĞµÑÑ‚Ğ¾',
      ko: 'ì¥ì†Œ',
      'zh-cn': 'æ™¯ç‚¹',
      'zh-tw': 'æ™¯é»',
      ar: 'Ù…ÙƒØ§Ù†',
      tr: 'Yer',
      th: 'à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ',
      nl: 'Plaats',
      pl: 'Miejsce',
      sv: 'Plats',
      da: 'Sted',
      fi: 'Paikka',
      id: 'Tempat'
    },
    colors: 'bg-brand-100 text-brand-700'
  },
  food: {
    emoji: 'ğŸ£',
    label: { 
      ja: 'ã‚°ãƒ«ãƒ¡', 
      en: 'Food',
      es: 'Comida',
      fr: 'Cuisine',
      de: 'Essen',
      it: 'Cibo',
      'pt-br': 'Comida',
      ru: 'Ğ•Ğ´Ğ°',
      ko: 'ìŒì‹',
      'zh-cn': 'ç¾é£Ÿ',
      'zh-tw': 'ç¾é£Ÿ',
      ar: 'Ø·Ø¹Ø§Ù…',
      tr: 'Yemek',
      th: 'à¸­à¸²à¸«à¸²à¸£',
      nl: 'Eten',
      pl: 'Jedzenie',
      sv: 'Mat',
      da: 'Mad',
      fi: 'Ruoka',
      id: 'Makanan'
    },
    colors: 'bg-secondary-100 text-secondary-700'
  },
  transport: {
    emoji: 'ğŸš„',
    label: { 
      ja: 'äº¤é€š', 
      en: 'Transport',
      es: 'Transporte',
      fr: 'Transport',
      de: 'Transport',
      it: 'Trasporto',
      'pt-br': 'Transporte',
      ru: 'Ğ¢Ñ€Ğ°Ğ½ÑĞ¿Ğ¾Ñ€Ñ‚',
      ko: 'êµí†µ',
      'zh-cn': 'äº¤é€š',
      'zh-tw': 'äº¤é€š',
      ar: 'Ù†Ù‚Ù„',
      tr: 'UlaÅŸÄ±m',
      th: 'à¸à¸²à¸£à¸‚à¸™à¸ªà¹ˆà¸‡',
      nl: 'Vervoer',
      pl: 'Transport',
      sv: 'Transport',
      da: 'Transport',
      fi: 'Liikenne',
      id: 'Transportasi'
    },
    colors: 'bg-accent-100 text-accent-700'
  },
  hotel: {
    emoji: 'ğŸ›ï¸',
    label: { 
      ja: 'å®¿æ³Š', 
      en: 'Hotel',
      es: 'Hotel',
      fr: 'HÃ´tel',
      de: 'Hotel',
      it: 'Hotel',
      'pt-br': 'Hotel',
      ru: 'ĞÑ‚ĞµĞ»ÑŒ',
      ko: 'ìˆ™ë°•',
      'zh-cn': 'é…’åº—',
      'zh-tw': 'é…’åº—',
      ar: 'ÙÙ†Ø¯Ù‚',
      tr: 'Otel',
      th: 'à¹‚à¸£à¸‡à¹à¸£à¸¡',
      nl: 'Hotel',
      pl: 'Hotel',
      sv: 'Hotell',
      da: 'Hotel',
      fi: 'Hotelli',
      id: 'Hotel'
    },
    colors: 'bg-purple-100 text-purple-700'
  },
  note: {
    emoji: 'ğŸ“',
    label: { 
      ja: 'ãƒ¡ãƒ¢', 
      en: 'Note',
      es: 'Nota',
      fr: 'Note',
      de: 'Notiz',
      it: 'Nota',
      'pt-br': 'Nota',
      ru: 'Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ°',
      ko: 'ë©”ëª¨',
      'zh-cn': 'ç¬”è®°',
      'zh-tw': 'ç­†è¨˜',
      ar: 'Ù…Ù„Ø§Ø­Ø¸Ø©',
      tr: 'Not',
      th: 'à¸šà¸±à¸™à¸—à¸¶à¸',
      nl: 'Notitie',
      pl: 'Notatka',
      sv: 'Anteckning',
      da: 'Note',
      fi: 'Muistiinpano',
      id: 'Catatan'
    },
    colors: 'bg-gray-100 text-gray-700'
  }
}

const config = typeConfig[article.type as keyof typeof typeConfig] || typeConfig.note
const typeLabel = config.label[lang as keyof typeof config.label] || config.label.ja

// Tag color variable mapping (ensure 'food' maps to '--tag-gourmet')
const tagVarMap: Record<string, string> = {
  spot: '--tag-spot',
  food: '--tag-gourmet',
  transport: '--tag-transport',
  hotel: '--tag-hotel',
  note: '--tag-note',
  event: '--tag-event'
}
const tagVar = tagVarMap[article.type] || '--tag-note'
// Inline style leveraging CSS color-mix when available; falls back to solid color
const badgeStyle = `background: color-mix(in srgb, var(${tagVar}) 80%, white 20%); border-color: color-mix(in srgb, var(${tagVar}) 65%, white 35%); box-shadow: 0 3px 8px color-mix(in srgb, var(${tagVar}) 18%, transparent);`

// å¤šè¨€èªå¯¾å¿œURLç”Ÿæˆ
const articleUrl = lang === 'ja' 
  ? `/article/${article._id}` 
  : `/${lang}/article/${article._id}`
---

<a 
  href={articleUrl} 
  class="block mb-4 bg-white rounded-2xl shadow-[0_1px_3px_rgba(0,0,0,0.08)] hover:shadow-[0_8px_25px_rgba(0,0,0,0.15)] hover:scale-[1.02] hover:-translate-y-1 active:scale-[0.98] active:translate-y-0 transition-all duration-500 ease-out overflow-hidden group border border-neutral-100 relative article-card"
  data-article
  data-title={article.title}
  data-type={article.type}
  data-place-name={article.placeName || ''}
  data-prefecture={article.prefecture || ''}
  data-body-text={article.bodyText || ''}
>
  <!-- Thumbnail -->
  {article.coverImage?.asset?.url && (
    <div class="relative aspect-video overflow-hidden rounded-xl">
      <img 
        src={`${article.coverImage.asset.url}?w=600&h=338&fit=crop&auto=format`}
        alt={`${article.placeName || ''} ${article.title}`.trim()}
        class="w-full h-full object-cover transition-transform duration-700 ease-out group-hover:scale-110"
        loading="lazy"
        decoding="async"
      />
      <!-- Type Badge (refined) -->
      {config.emoji && (
        <div 
          class="absolute top-2 left-2 inline-flex items-center gap-1 pl-2 pr-2.5 py-1 rounded-2xl text-[10px] text-white/95 font-medium ring-1 ring-white/40 backdrop-blur-[1px] opacity-90 transition-opacity duration-300 group-hover:opacity-100"
          style={badgeStyle}
        >
          <span class="-ml-0.5 drop-shadow-[0_1px_0_rgba(0,0,0,0.25)]">{config.emoji}</span>
          <span class="tracking-wide">{typeLabel}</span>
        </div>
      )}
    </div>
  )}
  
  <div class="p-4">
    <!-- Title (2 lines max) -->
    <h3 class="line-clamp-2 text-[17px] font-semibold leading-snug text-gray-900 mb-2 transition-colors duration-300 group-hover:text-brand-600">
      {article.title}
    </h3>
    
    <!-- Gallery preview (if available) -->
    {article.gallery && article.gallery.length > 0 && (
      <div class="mb-4">
        <div class="flex gap-3 overflow-x-auto pb-2">
          {article.gallery.slice(0, 5).map((image, index) => (
            <div class="relative group/gallery">
              <img 
                src={`${image.asset.url}?w=56&h=56&fit=crop&auto=format`}
                alt=""
                class="w-14 h-14 object-cover rounded-xl flex-shrink-0 ring-2 ring-white/50 shadow-lg hover:ring-brand-400 hover:scale-110 transition-all duration-300 hover:shadow-xl group-hover:animate-pulse"
                loading="lazy"
                decoding="async"
                style={`--animation-delay: ${index * 100}ms; animation-delay: var(--animation-delay);`}
              />
              <div class="absolute inset-0 bg-gradient-to-t from-brand-500/20 to-transparent opacity-0 group-hover/gallery:opacity-100 transition-opacity duration-300 rounded-xl"></div>
            </div>
          ))}
          {article.gallery.length > 5 && (
            <div class="relative group/gallery">
              <div class="w-14 h-14 rounded-xl flex-shrink-0 ring-2 ring-white/50 shadow-lg bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center hover:ring-brand-400 hover:scale-110 transition-all duration-300 hover:shadow-xl">
                <span class="text-xs text-gray-600 font-medium">+{article.gallery.length - 5}</span>
              </div>
              <div class="absolute inset-0 bg-gradient-to-t from-brand-500/20 to-transparent opacity-0 group-hover/gallery:opacity-100 transition-opacity duration-300 rounded-xl"></div>
            </div>
          )}
        </div>
      </div>
    )}
    
    <!-- Meta info (1 line) with bullet separator -->
    <div class="flex items-center gap-1.5 text-xs text-neutral-500">
      {article.placeName && (
        <>
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          <span>{article.placeName}</span>
          <span>ãƒ»</span>
        </>
      )}
      <time datetime={article.publishedAt}>
        {formatDate(article.publishedAt)}
      </time>
    </div>
  </div>
</a>

<style>
  /* Line clamping for mobile optimization */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>