---
import type { Article } from '../lib/sanity'
import { DEFAULT_LANGUAGE } from '../lib/i18n'

interface Props {
  article: Article
  lang?: string
}

const { article, lang = DEFAULT_LANGUAGE } = Astro.props

const formatDate = (dateString: string) => {
  const locale = lang === 'ja' ? 'ja-JP' :
                 lang === 'en' ? 'en-US' :
                 lang === 'zh-cn' ? 'zh-CN' :
                 lang === 'zh-tw' ? 'zh-TW' :
                 lang === 'ko' ? 'ko-KR' :
                 lang === 'th' ? 'th-TH' :
                 lang === 'vi' ? 'vi-VN' :
                 lang === 'ar' ? 'ar-SA' :
                 lang === 'hi' ? 'hi-IN' :
                 lang === 'ru' ? 'ru-RU' :
                 lang === 'fr' ? 'fr-FR' :
                 lang === 'de' ? 'de-DE' :
                 lang === 'es' ? 'es-ES' :
                 lang === 'it' ? 'it-IT' :
                 lang === 'pt' ? 'pt-PT' :
                 lang === 'pt-br' ? 'pt-BR' :
                 lang === 'tr' ? 'tr-TR' :
                 'en-US'
  
  return new Date(dateString).toLocaleDateString(locale, {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  })
}

const typeConfig = {
  spot: {
    emoji: 'üóæ',
    label: { ja: '„Çπ„Éù„ÉÉ„Éà', en: 'Spot' },
    colors: 'bg-brand-100 text-brand-700'
  },
  food: {
    emoji: 'üç£',
    label: { ja: '„Ç∞„É´„É°', en: 'Food' },
    colors: 'bg-secondary-100 text-secondary-700'
  },
  transport: {
    emoji: 'üöÑ',
    label: { ja: '‰∫§ÈÄö', en: 'Transport' },
    colors: 'bg-accent-100 text-accent-700'
  },
  hotel: {
    emoji: 'üõèÔ∏è',
    label: { ja: 'ÂÆøÊ≥ä', en: 'Hotel' },
    colors: 'bg-purple-100 text-purple-700'
  },
  note: {
    emoji: 'üìù',
    label: { ja: '„É°„É¢', en: 'Note' },
    colors: 'bg-gray-100 text-gray-700'
  }
}

const config = typeConfig[article.type as keyof typeof typeConfig] || typeConfig.note
const typeLabel = config.label[lang as keyof typeof config.label] || config.label.ja

// Â§öË®ÄË™ûÂØæÂøúURLÁîüÊàê
const articleUrl = lang === 'ja' 
  ? `/article/${article._id}` 
  : `/${lang}/article/${article._id}`
---

<a 
  href={articleUrl} 
  class="block mb-4 bg-white rounded-xl shadow-sm hover:opacity-95 transition-all duration-300 overflow-hidden group border border-neutral-100 relative article-card"
  data-article
  data-title={article.title}
  data-type={article.type}
  data-place-name={article.placeName || ''}
  data-prefecture={article.prefecture || ''}
  data-body-text={article.bodyText || ''}
>
  <!-- Thumbnail -->
  {article.coverImage?.asset?.url && (
    <div class="relative aspect-video overflow-hidden rounded-xl">
      <img 
        src={`${article.coverImage.asset.url}?w=600&h=338&fit=crop&auto=format`}
        alt={`${article.placeName || ''} ${article.title}`.trim()}
        class="w-full h-full object-cover"
        loading="lazy"
        decoding="async"
      />
      <!-- Optional Type Label -->
      {config.emoji && (
        <div class="absolute top-2 left-2 px-2 py-0.5 rounded-full text-[11px] bg-black/55 text-white font-medium">
          {config.emoji} {typeLabel}
        </div>
      )}
    </div>
  )}
  
  <div class="p-4">
    <!-- Title (2 lines max) -->
    <h3 class="line-clamp-2 text-[17px] font-semibold leading-snug text-gray-900 mb-2">
      {article.title}
    </h3>
    
    <!-- Meta info (1 line) -->
    <div class="flex items-center gap-2 text-xs text-neutral-500">
      {article.placeName && (
        <>
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          <span>{article.placeName}</span>
          <span>‚Ä¢</span>
        </>
      )}
      <time datetime={article.publishedAt}>
        {formatDate(article.publishedAt)}
      </time>
    </div>
  </div>
</a>

<style>
  /* Line clamping for mobile optimization */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>