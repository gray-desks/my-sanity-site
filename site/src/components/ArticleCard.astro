---
import type { Article } from '../lib/sanity'
import { DEFAULT_LANGUAGE } from '../lib/i18n'

interface Props {
  article: Article
  lang?: string
}

const { article, lang = DEFAULT_LANGUAGE } = Astro.props

const formatDate = (dateString: string) => {
  // å‹•çš„ãƒ­ã‚±ãƒ¼ãƒ«å–å¾—
  const localeMap: Record<string, string> = {
    ja: 'ja-JP',
    en: 'en-US',
    'zh-cn': 'zh-CN',
    'zh-tw': 'zh-TW',
    ko: 'ko-KR',
    th: 'th-TH',
    ar: 'ar-SA',
    ru: 'ru-RU',
    fr: 'fr-FR',
    de: 'de-DE',
    es: 'es-ES',
    it: 'it-IT',
    'pt-br': 'pt-BR',
    tr: 'tr-TR',
    nl: 'nl-NL',
    pl: 'pl-PL',
    sv: 'sv-SE',
    da: 'da-DK',
    fi: 'fi-FI',
    id: 'id-ID'
  }
  const locale = localeMap[lang] || 'en-US'
  
  return new Date(dateString).toLocaleDateString(locale, {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  })
}

const typeConfig = {
  spot: {
    emoji: 'ğŸ—¾',
    label: { ja: 'ã‚¹ãƒãƒƒãƒˆ', en: 'Spot' },
    colors: 'bg-brand-100 text-brand-700'
  },
  food: {
    emoji: 'ğŸ£',
    label: { ja: 'ã‚°ãƒ«ãƒ¡', en: 'Food' },
    colors: 'bg-secondary-100 text-secondary-700'
  },
  transport: {
    emoji: 'ğŸš„',
    label: { ja: 'äº¤é€š', en: 'Transport' },
    colors: 'bg-accent-100 text-accent-700'
  },
  hotel: {
    emoji: 'ğŸ›ï¸',
    label: { ja: 'å®¿æ³Š', en: 'Hotel' },
    colors: 'bg-purple-100 text-purple-700'
  },
  note: {
    emoji: 'ğŸ“',
    label: { ja: 'ãƒ¡ãƒ¢', en: 'Note' },
    colors: 'bg-gray-100 text-gray-700'
  }
}

const config = typeConfig[article.type as keyof typeof typeConfig] || typeConfig.note
const typeLabel = config.label[lang as keyof typeof config.label] || config.label.ja

// å¤šè¨€èªå¯¾å¿œURLç”Ÿæˆ
const articleUrl = lang === 'ja' 
  ? `/article/${article._id}` 
  : `/${lang}/article/${article._id}`
---

<a 
  href={articleUrl} 
  class="block mb-4 bg-white rounded-2xl shadow-[0_1px_3px_rgba(0,0,0,0.08)] hover:opacity-95 hover:shadow-[0_2px_6px_rgba(0,0,0,0.12)] active:opacity-90 transition-all duration-300 overflow-hidden group border border-neutral-100 relative article-card"
  data-article
  data-title={article.title}
  data-type={article.type}
  data-place-name={article.placeName || ''}
  data-prefecture={article.prefecture || ''}
  data-body-text={article.bodyText || ''}
>
  <!-- Thumbnail -->
  {article.coverImage?.asset?.url && (
    <div class="relative aspect-video overflow-hidden rounded-xl">
      <img 
        src={`${article.coverImage.asset.url}?w=600&h=338&fit=crop&auto=format`}
        alt={`${article.placeName || ''} ${article.title}`.trim()}
        class="w-full h-full object-cover"
        loading="lazy"
        decoding="async"
      />
      <!-- Optional Type Label with theme color -->
      {config.emoji && (
        <div class="absolute top-2 left-2 px-2 py-0.5 rounded-full text-[11px] text-white font-medium" style={`background: var(--tag-${article.type})`}>
          {config.emoji} {typeLabel}
        </div>
      )}
    </div>
  )}
  
  <div class="p-4">
    <!-- Title (2 lines max) -->
    <h3 class="line-clamp-2 text-[17px] font-semibold leading-snug text-gray-900 mb-2">
      {article.title}
    </h3>
    
    <!-- Gallery preview (if available) -->
    {article.gallery && article.gallery.length > 0 && (
      <div class="flex gap-1 mb-3 overflow-hidden">
        {article.gallery.slice(0, 4).map((image, index) => (
          <div class="flex-shrink-0 w-12 h-12 rounded-lg overflow-hidden border border-neutral-200">
            <img 
              src={`${image.asset.url}?w=48&h=48&fit=crop&auto=format`}
              alt=""
              class="w-full h-full object-cover"
              loading="lazy"
            />
          </div>
        ))}
        {article.gallery.length > 4 && (
          <div class="flex-shrink-0 w-12 h-12 rounded-lg bg-neutral-100 border border-neutral-200 flex items-center justify-center">
            <span class="text-xs text-neutral-500 font-medium">+{article.gallery.length - 4}</span>
          </div>
        )}
      </div>
    )}
    
    <!-- Meta info (1 line) with bullet separator -->
    <div class="flex items-center gap-1.5 text-xs text-neutral-500">
      {article.placeName && (
        <>
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          <span>{article.placeName}</span>
          <span>ãƒ»</span>
        </>
      )}
      <time datetime={article.publishedAt}>
        {formatDate(article.publishedAt)}
      </time>
    </div>
  </div>
</a>

<style>
  /* Line clamping for mobile optimization */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>