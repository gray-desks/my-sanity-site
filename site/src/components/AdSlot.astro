---
export interface Props {
  slotId: string
  format?: "horizontal" | "in-article" | "in-feed" | "rectangle"
  reserveHeight?: number
  label?: string
  class?: string
  hideOn?: "mobile" | "desktop" | "none"
}

const { 
  slotId,
  format = "horizontal",
  reserveHeight = 120,
  label = "Â∫ÉÂëä",
  class: className = "",
  hideOn = "none"
} = Astro.props

// Only show ads if environment variable is set
const adsenseClientId = import.meta.env.PUBLIC_ADSENSE_CLIENT_ID
const isDev = import.meta.env.DEV

// Exclude ads on privacy policy pages
const currentPath = Astro.url.pathname
const isPrivacyPage = currentPath === '/privacy' || currentPath === '/en/privacy'

// Don't show ads if slotId is empty (Êú™ÂÆüË£Ö„ÅÆÂ∫ÉÂëä„É¶„Éã„ÉÉ„Éà)
const hasValidSlotId = slotId && slotId.trim() !== ""

const showAds = adsenseClientId && adsenseClientId !== "" && !isPrivacyPage && hasValidSlotId

// Responsive classes based on hideOn prop
const responsiveClasses = {
  mobile: "hidden md:block",
  desktop: "block md:hidden", 
  none: "block"
}

// Format-specific configurations
const formatConfig = {
  horizontal: {
    adFormat: "auto",
    containerClass: "w-full",
    height: reserveHeight || 120
  },
  "in-article": {
    adFormat: "fluid",
    containerClass: "w-full my-8",
    height: reserveHeight || 250
  },
  "in-feed": {
    adFormat: "fluid",
    containerClass: "w-full",
    height: reserveHeight || 200
  },
  rectangle: {
    adFormat: "auto", 
    containerClass: "w-full max-w-md mx-auto",
    height: reserveHeight || 250
  }
}

const config = formatConfig[format]
---

{showAds ? (
  <div class={`ad-container ${responsiveClasses[hideOn]} ${className}`}>
    <!-- Ad label -->
    <div class="text-xs text-neutral-400 text-center mb-2">{label}</div>
    
    <!-- Ad slot with CLS prevention -->
    <div 
      class={`ad-slot ${config.containerClass}`} 
      style={`min-height: ${config.height}px;`}
    >
      {isDev ? (
        <!-- Development placeholder -->
        <div 
          class="bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center text-center"
          style={`height: ${config.height}px;`}
        >
          <div class="text-gray-500">
            <div class="text-2xl mb-2">üì¢</div>
            <p class="font-medium text-sm">Google AdSense</p>
            <p class="text-xs mt-1">Slot: {slotId}</p>
            <p class="text-xs">Format: {format}</p>
          </div>
        </div>
      ) : (
        <!-- Production ad -->
        <ins 
          class="adsbygoogle block w-full"
          style="display:block"
          data-ad-client={adsenseClientId}
          data-ad-slot={slotId}
          data-ad-format={config.adFormat}
          data-full-width-responsive="true"
        ></ins>
      )}
    </div>
  </div>
) : null}

{/* Optimized AdSense push with intersection observer */}
{showAds && !isDev && (
  <script is:inline define:vars={{slotId}}>
    // Use intersection observer to load ads only when visible
    (() => {
      const adElement = document.querySelector(`ins[data-ad-slot="${slotId}"]`);
      if (!adElement) return;
      
      let pushed = false;
      const pushAd = () => {
        if (pushed || !window.adsbygoogle) return;
        pushed = true;
        
        try {
          (window.adsbygoogle = window.adsbygoogle || []).push({});
        } catch(e) {
          console.debug('AdSense push failed:', e.message);
        }
      };
      
      // Push ad when it becomes visible or after AdSense script loads
      if ('IntersectionObserver' in window) {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              observer.disconnect();
              // Small delay to ensure AdSense script is ready
              setTimeout(pushAd, 100);
            }
          });
        }, { rootMargin: '100px' });
        
        observer.observe(adElement);
      } else {
        // Fallback for older browsers
        setTimeout(pushAd, 1000);
      }
    })();
  </script>
)}

<style>
  .ad-container {
    /* Ensure ads don't cause layout shifts */
    contain: layout style;
  }
  
  .ad-slot {
    /* Smooth transitions for ad loading */
    transition: all 0.3s ease;
  }
  
  /* Ensure ads are accessible */
  .adsbygoogle {
    outline: none;
  }
</style>