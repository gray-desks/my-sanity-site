---
import Layout from '../../layouts/Layout.astro'
import Hero from '../../components/Hero.astro'
import AdSlot from '../../components/AdSlot.astro'
import ArticleCard from '../../components/ArticleCard.astro'
import SearchFilter from '../../components/SearchFilter.astro'
import { getArticles, type Article } from '../../lib/sanity'
import { ENABLED_LANGUAGES, getUILabel } from '../../lib/i18n'
import { ADS_SLOTS } from '../../config/ads'

export async function getStaticPaths() {
  // Êó•Êú¨Ë™û‰ª•Â§ñ„ÅÆÊúâÂäπ„Å™Ë®ÄË™û„ÅÆ„Éë„Çπ„ÇíÁîüÊàê
  const paths = ENABLED_LANGUAGES
    .filter(lang => lang.id !== 'ja')
    .map(lang => ({
      params: { lang: lang.id }
    }))
  
  return paths
}

const { lang } = Astro.params

let articles: Article[] = []
try {
  articles = await getArticles(lang)
} catch (error) {
  console.error('Failed to fetch articles:', error)
}
---

<Layout 
  title={`${getUILabel(lang, 'siteTitle')} - ${getUILabel(lang, 'siteDescription')}`}
  description={getUILabel(lang, 'siteDescription')}
  lang={lang}
>
  <!-- Hero Section -->
  <Hero lang={lang} />

  <!-- Top Ad - HeroÁõ¥‰∏ã -->
  <div class="max-w-7xl mx-auto px-4 pt-8">
    <AdSlot
      slotId={ADS_SLOTS.HOME_HERO}
      format="horizontal" 
      reserveHeight={120}
      label={lang === 'en' ? 'Advertisement' : lang === 'zh-cn' ? 'ÂπøÂëä' : lang === 'zh-tw' ? 'Âª£Âëä' : lang === 'ko' ? 'Í¥ëÍ≥†' : 'Â∫ÉÂëä'}
      class="mb-8"
    />
  </div>

  <div class="max-w-7xl mx-auto px-4 py-8 space-y-16">
    <!-- Search and Filter Section -->
    <SearchFilter lang={lang} />
    
    <!-- Articles Section with In-Feed Ads -->
    <section id="articles" class="relative">
      {articles.length === 0 ? (
        <div class="text-center py-16 bg-white rounded-2xl shadow-lg border border-gray-100">
          <div class="text-6xl mb-4">üìù</div>
          <p class="text-gray-500 text-xl mb-2">{getUILabel(lang, 'noArticlesTitle')}</p>
          <p class="text-gray-400">{getUILabel(lang, 'noArticlesSubtitle')}</p>
        </div>
      ) : (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {articles.map((article, index) => (
            <>
              <ArticleCard article={article} lang={lang} />
              {/* In-feed ads every 4 articles */}
              {(index + 1) % 4 === 0 && index < articles.length - 1 && (
                <div class="col-span-1 md:col-span-2 lg:col-span-3">
                  <AdSlot
                    slotId={ADS_SLOTS.HOME_INFEED}
                    format="in-feed"
                    reserveHeight={200}
                    label={lang === 'en' ? 'Advertisement' : lang === 'zh-cn' ? 'ÂπøÂëä' : lang === 'zh-tw' ? 'Âª£Âëä' : lang === 'ko' ? 'Í¥ëÍ≥†' : 'Â∫ÉÂëä'}
                    class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6"
                  />
                </div>
              )}
            </>
          ))}
        </div>
      )}
    </section>

    <!-- Bottom Ad - „Éï„ÉÉ„Çø„ÉºÁõ¥Ââç -->
    <AdSlot
      slotId={ADS_SLOTS.HOME_FOOTER}
      format="horizontal"
      reserveHeight={120}
      label={lang === 'en' ? 'Advertisement' : lang === 'zh-cn' ? 'ÂπøÂëä' : lang === 'zh-tw' ? 'Âª£Âëä' : lang === 'ko' ? 'Í¥ëÍ≥†' : 'ÂπøÂëä'}
      class="mt-16"
    />
  </div>
</Layout>

<style>
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>