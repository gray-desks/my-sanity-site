---
import ArticleIndex from '../_templates/ArticleIndex.astro'
import { getArticlesPaged, getArticleCount } from '../../lib/sanity'
import { ENABLED_LANGUAGES, getUILabel } from '../../lib/i18n'
import { PAGE_SIZE, calculateTotalPages } from '../../config/site'

export const prerender = true

export async function getStaticPaths() {
  // 日本語以外の有効な言語のパスを生成
  const paths = ENABLED_LANGUAGES
    .filter(lang => lang.id !== 'ja')
    .map(lang => ({
      params: { lang: lang.id }
    }))
  
  return paths
}

const { lang } = Astro.params
const currentPage = 1
const basePath = `/${lang}`

// Fetch articles and count for first page
let articles = []
let totalPages = 1

try {
  const [articlesData, totalCount] = await Promise.all([
    getArticlesPaged(lang, 0, PAGE_SIZE),
    getArticleCount(lang)
  ])
  
  articles = articlesData
  totalPages = calculateTotalPages(totalCount, PAGE_SIZE)
} catch (error) {
  console.error('Failed to fetch articles:', error)
}

// SEO and meta information
const pageTitle = `${getUILabel(lang, 'siteTitle')} - ${getUILabel(lang, 'siteDescription')}`
const pageDescription = getUILabel(lang, 'siteDescription')
const canonicalUrl = `${Astro.site?.toString() || ''}${lang}/`

// Pagination URLs
const nextUrl = totalPages > 1 ? `/${lang}/page/2` : undefined
---

<ArticleIndex 
  articles={articles}
  currentPage={currentPage}
  totalPages={totalPages}
  lang={lang}
  basePath={basePath}
  pageTitle={pageTitle}
  pageDescription={pageDescription}
  canonicalUrl={canonicalUrl}
  nextUrl={nextUrl}
/>