---
import ArticleIndex from '../_templates/ArticleIndex.astro'
import { getArticlesWithFilters, getArticleCountWithFilters } from '../../lib/sanity'
import { PAGE_SIZE, calculateTotalPages } from '../../config/site'
import { getLangIds, getHreflangCode } from '../../lib/getSupportedLangs'
import { getUILabel } from '../../lib/i18n'

// Validate language parameter
const { lang } = Astro.params
const supportedLangs = getLangIds()

if (!lang || !supportedLangs.includes(lang)) {
  return Astro.redirect('/404')
}

const url = Astro.url
const searchTerm = (url.searchParams.get('q') || '').trim()
const type = (url.searchParams.get('type') || '').trim()
const prefecture = (url.searchParams.get('prefecture') || '').trim()
const currentPage = parseInt(url.searchParams.get('page') || '1', 10)

const page = Number.isFinite(currentPage) && currentPage > 0 ? currentPage : 1
const offset = (page - 1) * PAGE_SIZE

let articles = []
let totalCount = 0

try {
  const [articlesData, count] = await Promise.all([
    getArticlesWithFilters(lang, offset, PAGE_SIZE, searchTerm || undefined, type || undefined, prefecture || undefined),
    getArticleCountWithFilters(lang, searchTerm || undefined, type || undefined, prefecture || undefined)
  ])
  articles = articlesData
  totalCount = count
} catch (e) {
  console.error('Failed to fetch search results:', e)
}

const totalPages = calculateTotalPages(totalCount, PAGE_SIZE)

// Localized titles and descriptions
const searchResultsLabel = getUILabel(lang, 'searchResults') || 'Search Results'
const filterResultsLabel = getUILabel(lang, 'filterResults') || 'Filter Results'
const resultsFoundLabel = getUILabel(lang, 'resultsFound') || 'results found'

const pageTitle = `${searchResultsLabel}: ${searchTerm || filterResultsLabel} (${totalCount} ${resultsFoundLabel})`
const pageDescription = `${totalCount} ${resultsFoundLabel}`
const canonicalUrl = url.pathname + url.search

// Build query params for Pagination component (keeps current filters)
const queryParams: Record<string, string> = Object.fromEntries(url.searchParams)

// Generate proper basePath for this language
const basePath = `/${lang}/search`
---

<ArticleIndex 
  articles={articles}
  currentPage={page}
  totalPages={totalPages}
  lang={lang}
  basePath={basePath}
  pageTitle={pageTitle}
  pageDescription={pageDescription}
  canonicalUrl={canonicalUrl}
  paginationMode="query"
  paginationQueryParams={queryParams}
  isSearch={true}
  noindex={true}
/>