---
import Layout from '../../../layouts/Layout.astro'
import Gallery from '../../../components/Gallery.astro'
import AffiliateBlock from '../../../components/AffiliateBlock.astro'
import { getArticleBySlug, getEnabledLanguageArticleSlugs, getArticleTranslations } from '../../../lib/sanity'
import { ENABLED_LANGUAGES, DEFAULT_LANGUAGE, getLanguageInfo, isLanguageEnabled, getUILabel } from '../../../lib/i18n'
import { PortableText } from 'astro-portabletext'

export async function getStaticPaths() {
  // Phase 1ã®æœ‰åŠ¹è¨€èªã®ã¿ã§è¨˜äº‹ãƒšãƒ¼ã‚¸ã‚’ç”Ÿæˆ
  const slugs = await getEnabledLanguageArticleSlugs()
  
  // æ—¥æœ¬èªä»¥å¤–ã®è¨€èªã®ãƒ‘ã‚¹ã‚’ç”Ÿæˆ
  const paths = slugs
    .filter(item => item.lang !== DEFAULT_LANGUAGE)
    .map(item => ({
      params: {
        lang: item.lang,
        type: item.type,
        slug: item.slug
      }
    }))
  
  return paths
}

const { lang, type, slug } = Astro.params

// ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¤œè¨¼
if (!lang || !type || !slug || !isLanguageEnabled(lang)) {
  return Astro.redirect('/')
}

const languageInfo = getLanguageInfo(lang)!

// è¨˜äº‹ãƒ‡ãƒ¼ã‚¿å–å¾—
const article = await getArticleBySlug(slug, lang)

if (!article) {
  return Astro.redirect(`/${lang}`)
}

// ç¿»è¨³ç‰ˆè¨˜äº‹ã‚’å–å¾—
let translations: any[] = []
try {
  translations = await getArticleTranslations(article._id)
} catch (error) {
  console.warn('Failed to fetch translations:', error)
}

// æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
const formatDate = (dateString: string, langCode: string) => {
  const date = new Date(dateString)
  const locale = langCode === 'zh-cn' ? 'zh-CN' : 
                langCode === 'zh-tw' ? 'zh-TW' :
                langCode === 'pt-br' ? 'pt-BR' :
                langCode
  
  return date.toLocaleDateString(locale, {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  })
}

// ã‚¿ã‚¤ãƒ—ã®ãƒ­ãƒ¼ã‚«ãƒ©ã‚¤ã‚º
const getLocalizedType = (type: string, lang: string) => {
  const typeMap: Record<string, Record<string, string>> = {
    spot: {
      ja: 'ã‚¹ãƒãƒƒãƒˆ',
      en: 'Spot',
      'zh-cn': 'æ™¯ç‚¹',
      'zh-tw': 'æ™¯é»',
      ko: 'ëª…ì†Œ',
      th: 'à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ',
      vi: 'Äiá»ƒm tham quan'
    },
    food: {
      ja: 'ã‚°ãƒ«ãƒ¡',
      en: 'Food',
      'zh-cn': 'ç¾é£Ÿ',
      'zh-tw': 'ç¾é£Ÿ',
      ko: 'ìŒì‹',
      th: 'à¸­à¸²à¸«à¸²à¸£',
      vi: 'áº¨m thá»±c'
    },
    transport: {
      ja: 'äº¤é€š',
      en: 'Transport',
      'zh-cn': 'äº¤é€š',
      'zh-tw': 'äº¤é€š',
      ko: 'êµí†µ',
      th: 'à¸à¸²à¸£à¹€à¸”à¸´à¸™à¸—à¸²à¸‡',
      vi: 'Giao thÃ´ng'
    },
    hotel: {
      ja: 'å®¿æ³Š',
      en: 'Hotel',
      'zh-cn': 'ä½å®¿',
      'zh-tw': 'ä½å®¿',
      ko: 'ìˆ™ë°•',
      th: 'à¹‚à¸£à¸‡à¹à¸£à¸¡',
      vi: 'KhÃ¡ch sáº¡n'
    },
    note: {
      ja: 'ãƒ¡ãƒ¢',
      en: 'Note',
      'zh-cn': 'ç¬”è®°',
      'zh-tw': 'ç­†è¨˜',
      ko: 'ë©”ëª¨',
      th: 'à¸šà¸±à¸™à¸—à¸¶à¸',
      vi: 'Ghi chÃº'
    }
  }
  
  return typeMap[type]?.[lang] || typeMap[type]?.en || type
}

// Portable Text ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­å®š
const components = {}
---

<Layout 
  title={article.title}
  description={`${getLocalizedType(article.type, lang)} - ${article.title}`}
  lang={lang as 'ja' | 'en'}
>
  <article class="max-w-4xl mx-auto px-4 py-8">
    <!-- Article Header -->
    <header class="mb-8">
      <!-- Breadcrumb -->
      <nav class="mb-6 text-sm">
        <ol class="flex items-center space-x-2 text-gray-500">
          <li><a href={`/${lang === DEFAULT_LANGUAGE ? '' : lang}`} class="hover:text-brand-600 transition-colors">{getUILabel(lang, 'backToHome')}</a></li>
          <li class="before:content-['/'] before:mx-2">{getLocalizedType(article.type, lang)}</li>
          <li class="before:content-['/'] before:mx-2 text-gray-800 font-medium truncate">{article.title}</li>
        </ol>
      </nav>

      <!-- Article Meta -->
      <div class="flex flex-wrap items-center gap-4 mb-6">
        <span class={`inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold
          ${article.type === 'spot' ? 'bg-brand-100 text-brand-700' :
            article.type === 'food' ? 'bg-secondary-100 text-secondary-700' :
            article.type === 'transport' ? 'bg-accent-100 text-accent-700' :
            article.type === 'hotel' ? 'bg-purple-100 text-purple-700' :
            'bg-gray-100 text-gray-700'}
        `}>
          <span class="mr-1 text-base">
            {article.type === 'spot' ? 'ğŸ—¾' :
             article.type === 'food' ? 'ğŸ£' :
             article.type === 'transport' ? 'ğŸš„' :
             article.type === 'hotel' ? 'ğŸ›ï¸' : 'ğŸ“'}
          </span>
          {getLocalizedType(article.type, lang)}
        </span>
        
        <time datetime={article.publishedAt} class="text-gray-500 text-sm">
          {getUILabel(lang, 'publishedOn')}: {formatDate(article.publishedAt, lang)}
        </time>
        {article.visitDate && (
          <time datetime={article.visitDate} class="text-gray-500 text-sm">
            {getUILabel(lang, 'visitedOn')}: {formatDate(article.visitDate, lang)}
          </time>
        )}
        
        
      </div>

      <!-- Title -->
      <h1 class="text-3xl md:text-4xl lg:text-5xl font-black text-gray-900 mb-6 leading-tight">
        {article.title}
      </h1>

      <!-- Cover Image -->
      {article.coverImage?.asset?.url && (
        <div class="relative overflow-hidden rounded-2xl mb-8 aspect-[16/9] shadow-xl">
          <img 
            src={article.coverImage.asset.url}
            alt={article.title}
            class="w-full h-full object-cover"
            loading="eager"
          />
          <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent"></div>
        </div>
      )}
    </header>

    <!-- Article Content -->
    <div class="prose prose-lg max-w-none prose-headings:text-gray-900 prose-p:text-gray-700 prose-p:leading-relaxed prose-a:text-brand-600 prose-a:no-underline hover:prose-a:underline prose-strong:text-gray-900 prose-img:rounded-xl prose-img:shadow-lg">
      <PortableText value={article.body} components={components} />
    </div>

    <!-- Tags -->
    {article.tags && article.tags.length > 0 && (
      <div class="mt-12">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">
          {getUILabel(lang, 'tags')}
        </h2>
        <div class="flex flex-wrap gap-3">
          {article.tags.map(tag => (
            <span class="bg-gray-100 text-gray-800 px-4 py-2 rounded-full font-medium">
              {tag}
            </span>
          ))}
        </div>
      </div>
    )}

    <!-- Gallery -->
    {article.gallery && article.gallery.length > 0 && (
      <div class="mt-12">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">
          {lang === 'en' ? 'Gallery' : 
           lang === 'zh-cn' ? 'å›¾ç‰‡é›†' :
           lang === 'zh-tw' ? 'åœ–ç‰‡é›†' :
           lang === 'ko' ? 'ê°¤ëŸ¬ë¦¬' :
           lang === 'th' ? 'à¹à¸à¸¥à¹€à¸¥à¸­à¸£à¸µà¹ˆ' :
           lang === 'vi' ? 'ThÆ° viá»‡n áº£nh' :
           'ã‚®ãƒ£ãƒ©ãƒªãƒ¼'}
        </h2>
        <Gallery images={article.gallery} />
      </div>
    )}

    <!-- Language Versions -->
    {translations.length > 1 && (
      <div class="mt-12 p-6 bg-gradient-to-r from-gray-50 to-brand-50/30 rounded-2xl border border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
          {getUILabel(lang, 'switchLanguage')}
        </h3>
        <div class="flex flex-wrap gap-3">
          {translations
            .filter(t => isLanguageEnabled(t.lang))
            .map(translation => {
              const translationLangInfo = getLanguageInfo(translation.lang)
              if (!translationLangInfo) return null
              
              const isCurrentLang = translation.lang === lang
              const href = translation.lang === DEFAULT_LANGUAGE 
                ? `/${translation.type}/${translation.slug?.current}`
                : `/${translation.lang}/${translation.type}/${translation.slug?.current}`
              
              return (
                <a
                  href={href}
                  class={`inline-flex items-center px-4 py-2 rounded-xl text-sm font-medium transition-all
                    ${isCurrentLang 
                      ? 'bg-brand-600 text-white shadow-lg' 
                      : 'bg-white text-gray-700 hover:bg-brand-50 hover:text-brand-700 border border-gray-200 hover:border-brand-200'
                    }
                  `}
                >
                  <span class="mr-2">{translationLangInfo.id === 'ja' ? 'ğŸ‡¯ğŸ‡µ' : 
                                      translationLangInfo.id === 'en' ? 'ğŸ‡ºğŸ‡¸' :
                                      translationLangInfo.id === 'zh-cn' ? 'ğŸ‡¨ğŸ‡³' :
                                      translationLangInfo.id === 'zh-tw' ? 'ğŸ‡¹ğŸ‡¼' :
                                      translationLangInfo.id === 'ko' ? 'ğŸ‡°ğŸ‡·' :
                                      translationLangInfo.id === 'th' ? 'ğŸ‡¹ğŸ‡­' :
                                      translationLangInfo.id === 'vi' ? 'ğŸ‡»ğŸ‡³' : 'ğŸŒ'}</span>
                  {translationLangInfo.nativeName}
                </a>
              )
            })}
        </div>
      </div>
    )}
  </article>
</Layout>