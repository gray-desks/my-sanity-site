---
import Layout from '../../layouts/Layout.astro'
import Hero from '../../components/Hero.astro'
import AdSlot from '../../components/AdSlot.astro'
import ArticleCard from '../../components/ArticleCard.astro'
import SearchFilter from '../../components/SearchFilter.astro'
import Pagination from '../../components/Pagination.astro'
import { getUILabel } from '../../lib/i18n'
import { ADS_SLOTS, shouldShowAds } from '../../config/ads'
import type { Article } from '../../lib/sanity'

export interface Props {
  articles: Article[]
  currentPage: number
  totalPages: number
  lang: string
  basePath: string
  pageTitle: string
  pageDescription: string
  canonicalUrl: string
  prevUrl?: string
  nextUrl?: string
  paginationMode?: 'path' | 'query'
  paginationQueryParams?: Record<string, string>
  isSearch?: boolean
  noindex?: boolean
}

const { 
  articles, 
  currentPage, 
  totalPages, 
  lang, 
  basePath, 
  pageTitle, 
  pageDescription, 
  canonicalUrl,
  prevUrl,
  nextUrl,
  paginationMode,
  paginationQueryParams,
  isSearch = false,
  noindex = false
} = Astro.props

// Generate structured data for pagination
const structuredData = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": pageTitle,
  "description": pageDescription,
  "url": canonicalUrl
}

// List page ads gate (disable during AdSense review)
const LIST_ADS_ENABLED = import.meta.env.LIST_ADS_ENABLED === 'true'

---

<Layout 
  title={pageTitle}
  description={pageDescription}
  lang={lang}
  noindex={noindex}
>
  <!-- Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />

  <!-- Hero Section (consistent across all pages) -->
  <Hero lang={lang} />

  <!-- Top Ad - „Éí„Éº„É≠„Éº„ÅÆ‰∏ãÔºàÊ§úÁ¥¢„Éö„Éº„Ç∏„ÇÑË®ò‰∫ã0‰ª∂„ÅÆ„Å®„Åç„ÅØÈùûË°®Á§∫Ôºâ -->
  {(LIST_ADS_ENABLED && !isSearch && articles.length > 0) && (
    <div class="max-w-4xl lg:max-w-7xl mx-auto px-4 pt-2">
      <AdSlot
        slotId={ADS_SLOTS.HOME_HERO}
        format="horizontal" 
        reserveHeight={120}
        label={getUILabel(lang, 'advertisement')}
        class="mb-6"
      />
    </div>
  )}

  <div class="max-w-7xl mx-auto px-4 py-8 space-y-16">
    <!-- Page Title for pagination pages -->
    {currentPage > 1 && (
      <div class="text-center">
        <p class="text-lg text-secondary mb-2">
          {lang === 'en' 
            ? `${getUILabel(lang, 'page')} ${currentPage} ${getUILabel(lang, 'pageOf')} ${totalPages}` 
            : `${totalPages}${getUILabel(lang, 'pageOf')} ${currentPage}${getUILabel(lang, 'pageNumber')}`
          }
        </p>
      </div>
    )}
    
    <!-- Articles Section -->
    <section id="articles" class="relative">
      {articles.length === 0 ? (
        <div class="text-center py-16 bg-white rounded-2xl shadow-lg border border-gray-100">
          <div class="text-6xl mb-4">üìù</div>
          {isSearch ? (
            <>
              <p class="text-gray-500 text-xl mb-2">Ê§úÁ¥¢ÁµêÊûú„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</p>
              <p class="text-gray-400">„Ç≠„Éº„ÉØ„Éº„Éâ„ÇÑÊù°‰ª∂„ÇíÂ§âÊõ¥„Åó„Å¶ÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ</p>
            </>
          ) : (
            <>
              <p class="text-gray-500 text-xl mb-2">
                {currentPage > 1 
                  ? getUILabel(lang, 'noArticlesOnPage')
                  : getUILabel(lang, 'noArticlesTitle')
                }
              </p>
              <p class="text-gray-400">
                {currentPage > 1 
                  ? getUILabel(lang, 'tryDifferentPage')
                  : getUILabel(lang, 'noArticlesSubtitle')
                }
              </p>
            </>
          )}
        </div>
      ) : (
        <>
          <!-- Article Grid -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {articles.map((article, index) => (
              <ArticleCard article={article} lang={lang} />
            ))}
          </div>

          <!-- Pagination -->
          <Pagination 
            currentPage={currentPage}
            totalPages={totalPages}
            basePath={basePath}
            lang={lang}
            mode={paginationMode}
            queryParams={paginationQueryParams}
          />
        </>
      )}
    </section>

    <!-- Bottom Ad - „Éï„ÉÉ„Çø„ÉºÁõ¥ÂâçÔºàÊ§úÁ¥¢„Éö„Éº„Ç∏„ÇÑË®ò‰∫ã0‰ª∂„ÅÆ„Å®„Åç„ÅØÈùûË°®Á§∫Ôºâ -->
    {(LIST_ADS_ENABLED && !isSearch && articles.length > 0) && (
      <AdSlot
        slotId={ADS_SLOTS.HOME_FOOTER}
        format="horizontal"
        reserveHeight={120}
        label={getUILabel(lang, 'advertisement')}
        class="mt-16"
      />
    )}
  </div>
</Layout>

<style>
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>