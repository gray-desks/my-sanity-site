---
export const prerender = false;
import AdminLayout from '../../layouts/AdminLayout.astro';

const title = '記事管理';
---

<AdminLayout title={title}>
  <div class="mb-8">
    <h1 class="text-2xl font-bold text-gray-900">{title}</h1>
    <p class="mt-1 text-sm text-gray-500">記事の検索と一括削除を行えます。</p>
  </div>

  <!-- Filters and actions -->
  <div class="bg-white border border-gray-200 rounded-lg shadow-sm mb-4">
    <div class="p-4 grid gap-3 md:grid-cols-4">
      <div>
        <label class="block text-sm text-gray-600 mb-1">検索（タイトル）</label>
        <input id="filter-q" type="text" placeholder="キーワード"
               class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">言語</label>
        <select id="filter-lang" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
          <option value="">すべて</option>
          <option value="ja">ja</option>
          <option value="en">en</option>
          <option value="es">es</option>
          <option value="fr">fr</option>
          <option value="de">de</option>
          <option value="it">it</option>
          <option value="pt-br">pt-br</option>
          <option value="ru">ru</option>
          <option value="ko">ko</option>
          <option value="zh-cn">zh-cn</option>
          <option value="zh-tw">zh-tw</option>
          <option value="ar">ar</option>
          <option value="tr">tr</option>
          <option value="th">th</option>
          <option value="nl">nl</option>
          <option value="pl">pl</option>
          <option value="sv">sv</option>
          <option value="da">da</option>
          <option value="fi">fi</option>
          <option value="id">id</option>
        </select>
      </div>
      <div>
        <label class="block text-sm text-gray-600 mb-1">種類</label>
        <select id="filter-type" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
          <option value="">すべて</option>
          <option value="spot">spot</option>
          <option value="food">food</option>
          <option value="transport">transport</option>
          <option value="hotel">hotel</option>
          <option value="note">note</option>
        </select>
      </div>
      <div class="flex items-end gap-2">
        <button id="btn-search" class="px-4 py-2 rounded-lg text-white bg-purple-600 hover:bg-purple-700 text-sm">検索</button>
        <button id="btn-clear" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 text-sm">クリア</button>
      </div>
    </div>
  </div>

  <!-- Bulk actions bar -->
  <div class="flex items-center justify-between mb-3">
    <div class="text-sm text-gray-600">
      選択: <span id="selected-count">0</span> 件
    </div>
    <div class="flex items-center gap-2">
      <label class="inline-flex items-center text-sm text-gray-600 gap-2">
        <input id="include-drafts" type="checkbox" class="rounded border-gray-300" /> 下書きを含める
      </label>
      <button id="btn-delete" class="px-4 py-2 rounded-lg text-white bg-red-600 hover:bg-red-700 text-sm disabled:opacity-50" disabled>
        選択を一括削除
      </button>
    </div>
  </div>

  <!-- Table -->
  <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-2"><input id="check-all" type="checkbox" class="rounded border-gray-300" /></th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">タイトル</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">言語</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">種類</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">公開日</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
        </tr>
      </thead>
      <tbody id="tbody" class="bg-white divide-y divide-gray-100"></tbody>
    </table>
    <div class="flex items-center justify-between p-3 border-t border-gray-200 bg-gray-50 text-sm">
      <div id="paging-info" class="text-gray-600">0-0 / 0</div>
      <div class="flex gap-2">
        <button id="prev" class="px-3 py-1.5 rounded border bg-white text-gray-700 hover:bg-gray-50 disabled:opacity-50" disabled>前へ</button>
        <button id="next" class="px-3 py-1.5 rounded border bg-white text-gray-700 hover:bg-gray-50 disabled:opacity-50" disabled>次へ</button>
      </div>
    </div>
  </div>

  <script type="module" is:inline>
    const state = {
      offset: 0,
      limit: 50,
      total: 0,
      items: [],
      selected: new Set(),
    }

    const el = (id) => document.getElementById(id)
    const tbody = el('tbody')
    const selectedCount = el('selected-count')

    function getFilters() {
      return {
        q: el('filter-q').value.trim(),
        lang: el('filter-lang').value,
        type: el('filter-type').value,
        includeDrafts: el('include-drafts').checked ? '1' : '',
      }
    }

    function updateSelectionUI() {
      selectedCount.textContent = state.selected.size
      el('btn-delete').disabled = state.selected.size === 0
    }

    function renderRows(items) {
      tbody.innerHTML = ''
      for (const it of items) {
        const tr = document.createElement('tr')
        tr.innerHTML = `
          <td class="px-4 py-2"><input type="checkbox" class="row-check rounded border-gray-300" data-id="${it._id}"></td>
          <td class="px-4 py-2 text-sm text-gray-900">${it.title || '(無題)'}</td>
          <td class="px-4 py-2 text-sm text-gray-700">${it.lang || 'ja'}</td>
          <td class="px-4 py-2 text-sm text-gray-700">${it.type || ''}</td>
          <td class="px-4 py-2 text-sm text-gray-700">${it.publishedAt ? new Date(it.publishedAt).toLocaleDateString('ja-JP') : ''}</td>
          <td class="px-4 py-2 text-xs text-gray-500 font-mono">${it._id}</td>
        `
        tbody.appendChild(tr)
      }

      // wire up checkboxes
      tbody.querySelectorAll('.row-check').forEach((cb) => {
        const id = cb.getAttribute('data-id')
        cb.checked = state.selected.has(id)
        cb.addEventListener('change', () => {
          if (cb.checked) state.selected.add(id); else state.selected.delete(id)
          updateSelectionUI()
        })
      })

      // master checkbox state
      const all = Array.from(tbody.querySelectorAll('.row-check'))
      const master = el('check-all')
      master.checked = all.length > 0 && all.every((cb) => cb.checked)
    }

    async function fetchList() {
      const params = new URLSearchParams({
        offset: String(state.offset),
        limit: String(state.limit),
      })
      const { q, lang, type, includeDrafts } = getFilters()
      if (q) params.set('q', q)
      if (lang) params.set('lang', lang)
      if (type) params.set('type', type)
      if (includeDrafts) params.set('includeDrafts', '1')

      const res = await fetch(`/api/admin/articles/list?${params.toString()}`)
      if (!res.ok) throw new Error('一覧取得に失敗しました')
      const data = await res.json()
      state.items = data.items
      state.total = data.total
      renderRows(state.items)

      const from = state.total === 0 ? 0 : state.offset + 1
      const to = Math.min(state.offset + state.limit, state.total)
      document.getElementById('paging-info').textContent = `${from}-${to} / ${state.total}`
      el('prev').disabled = state.offset === 0
      el('next').disabled = state.offset + state.limit >= state.total
    }

    async function dryRun(ids) {
      const res = await fetch('/api/admin/articles/bulk-delete/dry-run', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids }),
      })
      if (!res.ok) throw new Error('ドライランに失敗しました')
      return await res.json()
    }

    async function doDelete(ids) {
      const res = await fetch('/api/admin/articles/bulk-delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids }),
      })
      if (!res.ok) throw new Error('削除に失敗しました')
      return await res.json()
    }

    // Events
    el('btn-search').addEventListener('click', async () => {
      state.offset = 0
      await fetchList()
    })
    el('btn-clear').addEventListener('click', async () => {
      el('filter-q').value = ''
      el('filter-lang').value = ''
      el('filter-type').value = ''
      state.offset = 0
      await fetchList()
    })

    el('prev').addEventListener('click', async () => {
      state.offset = Math.max(0, state.offset - state.limit)
      await fetchList()
    })
    el('next').addEventListener('click', async () => {
      state.offset = state.offset + state.limit
      await fetchList()
    })

    el('check-all').addEventListener('change', (e) => {
      const checked = e.target.checked
      state.items.forEach((it) => {
        if (checked) state.selected.add(it._id); else state.selected.delete(it._id)
      })
      renderRows(state.items)
      updateSelectionUI()
    })

    el('btn-delete').addEventListener('click', async () => {
      const ids = Array.from(state.selected)
      if (ids.length === 0) return

      const ok = confirm(`選択された ${ids.length} 件を削除します。よろしいですか？\n参照されているコンテンツや下書きも削除されます。この操作は取り消せません。`)
      if (!ok) return

      try {
        const result = await doDelete(ids)
        const fail = result.results.filter(r => !r.ok)
        if (fail.length > 0) {
          alert(`一部削除に失敗しました:\n` + fail.map(f => `- ${f.id}: ${f.error||'unknown'}`).join('\n'))
        } else {
          alert('削除が完了しました')
        }
        // refresh
        state.selected.clear()
        updateSelectionUI()
        await fetchList()
      } catch (e) {
        console.error(e)
        alert('削除処理でエラーが発生しました')
      }
    })

    // init
    await fetchList()
    updateSelectionUI()
  </script>
</AdminLayout>
