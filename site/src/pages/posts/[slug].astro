---
import Layout from '../../layouts/Layout.astro'
import BookingAffiliate from '../../components/BookingAffiliate.astro'
import AdSense from '../../components/AdSense.astro'
import { getPostBySlug, getTranslatedPost, getAllPostSlugs, type Post } from '../../lib/sanity'
import type { GetStaticPaths } from 'astro'

export const getStaticPaths: GetStaticPaths = async () => {
  try {
    const posts = await getAllPostSlugs()
    return posts.map(post => ({
      params: { slug: post.slug },
      props: { lang: post.lang }
    }))
  } catch (error) {
    console.error('Error in getStaticPaths:', error)
    return []
  }
}

const { slug } = Astro.params
const url = new URL(Astro.request.url)
const lang = url.searchParams.get('lang') as 'ja' | 'en' || 'ja'

let post: Post | null = null
let translatedPost: Post | null = null

try {
  post = await getPostBySlug(slug!, lang)
  
  // ä»–è¨€èªç‰ˆã‚’å–å¾—
  if (post) {
    const targetLang = lang === 'ja' ? 'en' : 'ja'
    translatedPost = await getTranslatedPost(post._id, targetLang)
  }
} catch (error) {
  console.error('Failed to fetch post:', error)
}

if (!post) {
  return Astro.redirect('/404')
}

const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString(lang === 'ja' ? 'ja-JP' : 'en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  })
}

const totalCost = (post.travelCost || 0) + (post.lodgingCost || 0)
---

<Layout 
  title={post.title} 
  description={post.excerpt || `${post.title}ã®æ—…è¨˜éŒ²`}
  lang={lang}
>
  <article class="max-w-4xl mx-auto">
    <!-- è¨€èªåˆ‡æ›¿ -->
    <div class="mb-6 flex justify-between items-center">
      <a 
        href="/" 
        class="text-blue-600 hover:text-blue-700 flex items-center"
      >
        â† {lang === 'ja' ? 'è¨˜äº‹ä¸€è¦§ã«æˆ»ã‚‹' : 'Back to Posts'}
      </a>
      
      {translatedPost && (
        <a 
          href={`/posts/${translatedPost.slug.current}?lang=${lang === 'ja' ? 'en' : 'ja'}`}
          class="bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded text-sm"
        >
          {lang === 'ja' ? 'ğŸ‡ºğŸ‡¸ English' : 'ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª'}
        </a>
      )}
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ç”»åƒ -->
    {post.mainImage?.asset?.url && (
      <div class="mb-8">
        <img 
          src={post.mainImage.asset.url}
          alt={post.title}
          class="w-full h-64 md:h-96 object-cover rounded-lg shadow-lg"
        />
      </div>
    )}

    <!-- ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ¡ã‚¿æƒ…å ± -->
    <header class="mb-8">
      <h1 class="text-3xl md:text-5xl font-bold mb-4 text-gray-900">
        {post.title}
      </h1>
      
      <div class="flex flex-wrap gap-4 text-sm text-gray-600 mb-4">
        <time datetime={post.publishedAt}>
          {lang === 'ja' ? 'æŠ•ç¨¿æ—¥' : 'Published'}: {formatDate(post.publishedAt)}
        </time>
        
        {post.tripDate && (
          <span>
            {lang === 'ja' ? 'æ—…è¡Œæ—¥' : 'Trip Date'}: {formatDate(post.tripDate)}
          </span>
        )}
        
        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">
          {lang === 'ja' ? 'æ—¥æœ¬èª' : 'English'}
        </span>
      </div>

      {post.excerpt && (
        <p class="text-lg text-gray-700 mb-6 border-l-4 border-blue-500 pl-4 italic">
          {post.excerpt}
        </p>
      )}
    </header>

    <!-- çµŒè²»æƒ…å ± -->
    {(post.travelCost || post.lodgingCost) && (
      <section class="bg-green-50 border border-green-200 rounded-lg p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4 text-green-800">
          ğŸ’° {lang === 'ja' ? 'æ—…è¡Œè²»ç”¨' : 'Travel Costs'}
        </h2>
        <div class="grid gap-3 md:grid-cols-3">
          {post.travelCost && (
            <div>
              <span class="text-sm text-green-600">
                {lang === 'ja' ? 'äº¤é€šè²»' : 'Transportation'}
              </span>
              <p class="text-lg font-semibold">Â¥{post.travelCost.toLocaleString()}</p>
            </div>
          )}
          
          {post.lodgingCost && (
            <div>
              <span class="text-sm text-green-600">
                {lang === 'ja' ? 'å®¿æ³Šè²»' : 'Accommodation'}
              </span>
              <p class="text-lg font-semibold">Â¥{post.lodgingCost.toLocaleString()}</p>
            </div>
          )}
          
          {totalCost > 0 && (
            <div>
              <span class="text-sm text-green-600">
                {lang === 'ja' ? 'åˆè¨ˆ' : 'Total'}
              </span>
              <p class="text-xl font-bold text-green-800">Â¥{totalCost.toLocaleString()}</p>
            </div>
          )}
        </div>
      </section>
    )}

    <!-- è¨˜äº‹æœ¬æ–‡ -->
    <section class="prose prose-lg max-w-none mb-8">
      {post.content && post.content.length > 0 ? (
        <div class="space-y-4">
          {post.content.map((block: any, index: number) => (
            <div key={index}>
              {block._type === 'block' && block.children && (
                <p class="text-gray-800 leading-relaxed">
                  {block.children.map((child: any) => child.text).join('')}
                </p>
              )}
            </div>
          ))}
        </div>
      ) : (
        <p class="text-gray-500 italic">
          {lang === 'ja' ? 'è¨˜äº‹ã®å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚' : 'No content available.'}
        </p>
      )}
    </section>

    <!-- ã‚¿ã‚° -->
    {post.tags && post.tags.length > 0 && (
      <section class="mb-8">
        <h3 class="text-lg font-semibold mb-3">
          {lang === 'ja' ? 'ã‚¿ã‚°' : 'Tags'}
        </h3>
        <div class="flex flex-wrap gap-2">
          {post.tags.map(tag => (
            <span class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm">
              #{tag}
            </span>
          ))}
        </div>
      </section>
    )}

    <!-- Booking.com ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆ -->
    <BookingAffiliate 
      lang={lang}
      destination={post.title}
    />

    <!-- Google AdSense åºƒå‘Š -->
    <AdSense 
      slot="article-bottom"
      format="auto"
      lang={lang}
      className="mb-8"
    />
  </article>
</Layout>