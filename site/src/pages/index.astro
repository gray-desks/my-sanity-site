---
import ArticleIndex from './_templates/ArticleIndex.astro'
import { getArticlesPaged, getArticleCount } from '../lib/sanity'
import { PAGE_SIZE, calculateTotalPages } from '../config/site'

const lang = 'ja'
const currentPage = 1
const basePath = ''

// Fetch articles and count for first page
let articles = []
let totalPages = 1

try {
  const [articlesData, totalCount] = await Promise.all([
    getArticlesPaged(lang, 0, PAGE_SIZE),
    getArticleCount(lang)
  ])
  
  articles = articlesData
  totalPages = calculateTotalPages(totalCount, PAGE_SIZE)
  // Debug: log article fetch result on server console
  console.log('[DEBUG] / index getArticlesPaged', {
    lang,
    fetched: Array.isArray(articlesData) ? articlesData.length : 'non-array',
    totalCount,
  })
} catch (error) {
  console.error('Failed to fetch articles:', error)
}

// SEO and meta information
const pageTitle = '旅ログ - 日本全国の旅記録'
const pageDescription = '日本全国の旅ログを多言語で発信するブログ。各地の魅力を写真と文章でお届けします。'
const canonicalUrl = Astro.site?.toString() || ''

// Pagination URLs
const nextUrl = totalPages > 1 ? '/page/2' : undefined
---

<ArticleIndex 
  articles={articles}
  currentPage={currentPage}
  totalPages={totalPages}
  lang={lang}
  basePath={basePath}
  pageTitle={pageTitle}
  pageDescription={pageDescription}
  canonicalUrl={canonicalUrl}
  nextUrl={nextUrl}
/>
